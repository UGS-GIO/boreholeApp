<html>
<head>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-PPGF6Z2N');</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="ArcGIS JS v4, Calcite Maps and Bootstrap Example">

  <title>Subsurface Geotechnical Database</title>

  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-bootstrap.min-v0.10.css">
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.10.css">
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/css/main.css">
   <link rel="stylesheet" href="/apps/_ugsmaptemplate/template.css">

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    h2 {
      font-size: 20px;
    }

    .ibox{
      outline:1px solid #e2e8f3;
      padding: 4px;
    }

    .calcite-title:before {
      content: url('https://geology.utah.gov/apps/_ugsmaptemplate/logo_main.png');
      padding: 6px 12px 0 2px;
      cursor: pointer;
    }

    .esri-feature__content-element {
        padding: 0 0 0 0;
    }
    .esri-popup__inline-actions-container>.esri-popup__action, .esri-popup__inline-actions-container>.esri-popup__action-toggle {
      margin: 0 7px;
      max-width: 100%;
    }
    .esri-popup__inline-actions-container:only-child>.esri-popup__action, .esri-popup__inline-actions-container:only-child>.esri-popup__action-toggle {
        max-width: 100%;
    }
    .esri-layer-list__item-actions-menu-item--active, .esri-layer-list__item-actions-menu-item--active:hover {
        background-color: #ffffff;
    }

    .field-heading {
      font: 600 12px Georgia, serif;
    }
    .field-data {
      font: 12px Georgia, serif;

    }

    .field-heading-sm {
      font: 600 11px Georgia, serif;
    }
    .field-data-sm {
      font: 11px Georgia, serif;

    }

  .esri-legend__layer-caption {
    display: none;
  }

    #statsDiv {
      position: absolute;
      bottom: 30px;
      left: 20px;
      color:black;
      font-size: 14px;
      font-weight: 700;
      background-color: rgba(255, 255, 255, 0.7); /* Added for visibility */
      padding: 5px;                         /* Added for visibility */
      border-radius: 4px;                   /* Added for visibility */
    }
    .bold{
      font-weight: 600;
    }

    /* ADDED: Loading Indicator Style */
    .page-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        font-size: 1.2em;
    }
    .page-loading img {
        margin-top: 10px;
        width: 50px; /* Adjust size as needed */
        height: 50px;
    }


  </style>

</head>

<body class="calcite-maps calcite-nav-top">

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PPGF6Z2N"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
    <div class="dropdown calcite-dropdown calcite-text-dark calcite-bg-light" role="presentation">
      <a class="dropdown-toggle" role="menubutton" aria-haspopup="true" aria-expanded="false" tabindex="0">
        <div class="calcite-dropdown-toggle">
          <span class="sr-only">Toggle dropdown menu</span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </a>
      <ul class="dropdown-menu" role="menu">
        <li><a role="menuitem" tabindex="0" data-target="#panelInfo" aria-haspopup="true"><span class="glyphicon glyphicon-info-sign"></span> About</a></li>
        <li><a role="menuitem" tabindex="0" href="#" data-target="#panelLegend" aria-haspopup="true"><span class="glyphicon glyphicon-list-alt"></span> Legend</a></li>
        <li><a role="menuitem" tabindex="0" href="#" data-target="#panelLayers" aria-haspopup="true"><span class="glyphicon glyphicon-list-alt"></span> Layers</a></li>
        </ul>
    </div>
    <div class="calcite-title calcite-overflow-hidden">
        <span class="calcite-title-main" style="color: white;">
          <a href="https://geology.utah.gov" style="color: white;">Utah Geological Survey</a>
        </span>

        <span class="calcite-title-divider hidden-xs"></span>
        <span class="calcite-title-sub hidden-xs" id="subTitle"> </span>
        <span class="calcite-title-sub hidden-xs" id="subTitle">Subsurface Geotechnical Database</span>
      </div>
    <ul class="nav navbar-nav calcite-nav">
      <li>
        <div class="calcite-navbar-search calcite-search-expander">
          <div id="searchWidgetDiv"></div>
        </div>
      </li>
    </ul>
  </nav>

  <div class="calcite-map calcite-map-absolute">
    <div id="mapViewDiv"></div>
    <div id="statsDiv"></div>
    <div class="page-loading" style="display: none;">
        <div>
            <h3>Loading...</h3>
            <p><small>Please wait.<br></small></p>
            <img src="https://geomap.geology.utah.gov/images/loading.gif" alt="loader"> </div>
    </div>
  </div>

  <div class="calcite-panels calcite-panels-right calcite-text-light calcite-bg-dark panel-group">

    <div id="panelInfo" class="panel collapse in">
      <div id="headingInfo" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseInfo"  aria-expanded="true" aria-controls="collapseInfo"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span><span class="panel-label">About</span></a>
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelInfo"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
        </div>
      </div>
      <div id="collapseInfo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingInfo">
        <div class="panel-body">
          <p><strong>Subsurface Geotechnical Database</strong></p>
          <p>
            This map shows a digital database of subsurface geologic data extracted from the <a target="_blank" style="color:blue;" href="https://geodata.geology.utah.gov/">UGS GeoData Archive</a>, a repository of generally unpublished data collected over decades by the UGS. The purpose of this map is to provide important information on the subsurface conditions and geology to support geologic and geotechnical investigations and other projects to complement existing geologic, geologic hazard, and other maps and data.
            <br><br>In a partnership with the Utah Department of Transportation (UDOT) and the U.S. Geological Survey, the UGS has made the geologic data within the archive more accessible for public use and further analysis. Relevant subsurface data have been extracted from the archived geotechnical and related reports, and each exploration location (borings, test pits, sample locations, etc.) is geolocated, as represented by colored points on this map. The data include information about the exploration location, descriptive soil units encountered, and soil sample and laboratory test data. Access to digital copies of the original reports is also provided when viewing borehole point data. Use the mouse to zoom to the area of interest then left click on a point to select the exploration location and view information about that location.
            <br><br>Extraction of geologic data from the Geodata Archive is ongoing and this map will be updated periodically.  These data will form the first phase of development of a three-dimensional geologic database of Utah.  We welcome donations of geologic reports and/or data we do not currently have in the archive, particularly development-related geotechnical reports, to further enhance the database and its usefulness.
          </p>
        </div>
     </div>
    </div>

    <div id="panelLegend" class="panel collapse">
      <div id="headingLegend" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseLegend" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><span class="panel-label">Legend</span></a>
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelLegend"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
        </div>
      </div>
      <div id="collapseLegend" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingLegend">
        <div class="panel-body">
          <div id="legendDiv"></div>
        </div>
      </div>
    </div>

    <div id="panelLayers" class="panel collapse">
      <div id="headingLayers" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseLayers" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><span class="panel-label">Layers</span></a>
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelLayers"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
        </div>
      </div>
      <div id="collapseLayers" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingLayers">
        <div class="panel-body">
          <div id="layersDiv"></div>
        </div>
      </div>
    </div>


    <div id="panelData" class="panel collapse">
      <div id="headingData" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseData" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><span class="panel-label">Data</span></a>
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelData"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
        </div>
      </div>
      <div id="collapseData" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingData">
        <div class="panel-body">
          <div id="dataDiv">

            <h2>Project Details</h2>
            <div id="projectDetails"></div>

            <h2>Unit Data</h2>
            <div id="unitData"></div>
            <button data-toggle="collapse" data-target="#unitDataExpand">Expand Detailed Data</button>
            <div id="unitDataExpand" class="collapse"></div>

            <h2>Sampling Data</h2>
            <div id="samplingData"></div>
            <button data-toggle="collapse" data-target="#samplingDataExpand">Expand Detailed Data</button>
            <div id="samplingDataExpand" class="collapse"></div>

          </div>
        </div>
      </div>
    </div>



  </div>

  <script type="text/javascript">
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: "https://esri.github.io/calcite-maps/dist/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: "https://esri.github.io/calcite-maps/dist/js/dojo"

      }]
    };
  </script>

  <script src="https://js.arcgis.com/4.21/"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyAi0ecBg7dfitM9Num5n7onxZATDSPaC_o",
        authDomain: "ut-dnr-ugs-borehole-prod.firebaseapp.com",
        projectId: "ut-dnr-ugs-borehole-prod",
        storageBucket: "ut-dnr-ugs-borehole-prod.appspot.com",
        messagingSenderId: "78333091254",
        appId: "1:78333091254:web:993c44895c1ea385dc3517",
        measurementId: "G-QP1XVRTH4Q"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const functions = getFunctions(app, 'us-central1'); // Specify region if needed

    // Make auth and functions globally accessible IF NEEDED by other scripts
    // This is generally not recommended, pass them as arguments instead if possible.
    window.firebaseAuth = auth;
    window.firebaseFunctions = functions;

    // Trigger Firebase initialization logic from the main ArcGIS script
    if (window.initializeFirebase) {
        window.initializeFirebase(auth, functions);
    } else {
        console.error("initializeFirebase function not found. Ensure ArcGIS script runs first or handle timing.");
    }

  </script>


  <script>
    let arcgisToken = null; // ADDED: Global variable for the token
    let map, mapView, fullscreen; // Make map and view global for access in functions
    const projectName = 'https://us-central1-ut-dnr-ugs-geolmapportal-prod.cloudfunctions.net'; // ADDED: Cloud Function URL base

    // ADDED: Function to show loading indicator
    function showLoading(message = 'Loading...') {
        const loadingDiv = document.querySelector('.page-loading');
        if (loadingDiv) {
            loadingDiv.querySelector('h3').textContent = message;
            loadingDiv.style.display = 'flex';
        }
    }

    // ADDED: Function to hide loading indicator
    function hideLoading() {
        const loadingDiv = document.querySelector('.page-loading');
        if (loadingDiv) {
            loadingDiv.style.display = 'none';
        }
    }


    // ADDED: Function to initialize Firebase Auth and get token
    window.initializeFirebase = function (auth, functions) {
        console.log('Initializing Firebase...');
        if (!auth || !functions) {
            console.error("Firebase Auth or Functions not available");
            continueMapInitialization(); // Proceed without token attempt
            return;
        }

        showLoading('Authenticating...');

        try {
            // Handle authentication state changes
            onAuthStateChanged(auth, function(user) {
                if (user) {
                    console.log('User is signed in:', user.uid);
                    // Get ArcGIS token after successful auth
                    getArcGISToken(functions);
                } else {
                    console.log('No user signed in, signing in anonymously...');
                    signInAnonymously(auth)
                        .catch(function(error) {
                            console.error('Anonymous sign-in error:', error);
                            const loadingDiv = document.querySelector('.page-loading');
                             if (loadingDiv) {
                                loadingDiv.innerHTML = '<div><h3>Authentication Error</h3><p><small>Failed to connect to map services. Please try again later.</small></p></div>';
                            }
                            continueMapInitialization(); // Proceed even if anonymous sign-in fails
                        });
                }
            });
        } catch (error) {
            console.error('Firebase initialization error:', error);
            const loadingDiv = document.querySelector('.page-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<div><h3>Service Error</h3><p><small>Failed to initialize map services. Please try again later.</small></p></div>';
            }
            continueMapInitialization(); // Proceed without Firebase
        }
    }

    // ADDED: Function to get ArcGIS token using Firebase Cloud Function
    function getArcGISToken(functions) {
        console.log('Getting ArcGIS token...');
        showLoading('Authenticating map services...');

        try {
            // Assuming functions instance is correctly initialized and passed
             const getArcGISTokenFn = httpsCallable(functions, 'getArcGISToken');

            getArcGISTokenFn()
                .then(function(result) {
                    // Read the token from the result and set to global variable
                    arcgisToken = result.data.token;
                    console.log('ArcGIS token received:', arcgisToken ? 'Token received successfully' : 'No token received');

                    // Continue with map initialization AFTER token attempt
                    continueMapInitialization();
                })
                .catch(function(error) {
                    console.error('Error getting ArcGIS token:', error);
                    const loadingDiv = document.querySelector('.page-loading');
                    if (loadingDiv) {
                      loadingDiv.innerHTML = '<div><h3>Authentication Warning</h3><p><small>Could not authenticate to secure service. Some features may be limited.</small></p></div>';
                    }
                    // Hide loading after a delay to show message
                    setTimeout(hideLoading, 3000);

                    // Continue with map initialization without loading the secured layer
                     continueMapInitialization();
                });
        } catch (error) {
            console.error('Error calling token function:', error);
             const loadingDiv = document.querySelector('.page-loading');
             if (loadingDiv) {
                 loadingDiv.innerHTML = '<div><h3>Function Error</h3><p><small>Problem calling authentication function.</small></p></div>';
             }
             setTimeout(hideLoading, 3000);

            // Continue with map initialization without the token or secured layer
            continueMapInitialization();
        }
    }

    // ADDED: Function to add layers that might need the token
    function addSecureLayers() {
        console.log("Attempting to add secure layers...");
        // --- MODIFIED mapLayer Definition ---
        var mapLayer = new TileLayer({
              url: "https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer",
              id: "24k",
              index: 0,
              opacity: 0.7,
              title: "1:24,000 Geologic Maps",
              visible: false, // Initially hidden, controlled by LayerList
              legendEnabled: false,
              //minScale: 30000,
              //maxScale: 4500,
              // ADDED: Use customParameters to pass the token
              customParameters: {
                  token: arcgisToken
              }
        });

        // Only add the layer if the token was successfully retrieved
        if (arcgisToken) {
            console.log("Adding '24k' layer with token.");
            map.add(mapLayer);
        } else {
            console.warn('ArcGIS token not available. Layer "24k" requiring token was not added.');
            // Optionally disable UI elements related to this layer if needed
            // e.g., find the layer list item and disable its checkbox
        }
    }


    // ADDED: Function to continue initialization after Firebase/token attempt
    function continueMapInitialization() {
         console.log('Continuing map initialization...');
         addSecureLayers(); // Add the layer(s) requiring the token
         // Add other initialization steps here if they depend on auth/token
         // or should wait until after the attempt.
         hideLoading(); // Hide loading indicator
    }


    require([
      // ArcGIS
      "esri/WebMap",
      "esri/views/MapView",
      // Widgets
      "esri/widgets/Home",
      "esri/widgets/Zoom",
      "esri/widgets/Compass",
      "esri/widgets/Search",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/widgets/BasemapToggle",
      "esri/widgets/Fullscreen",
      "esri/layers/FeatureLayer",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/layers/WFSLayer", // Corrected: WFSLayer
      "esri/layers/TileLayer",
      "esri/widgets/ScaleBar",
      "esri/widgets/Attribution",
      "esri/core/watchUtils",
      "dgrid/Grid",
      "dojo/query",
      "dojo/_base/array",
      // Bootstrap
      "bootstrap/Collapse",
      "bootstrap/Dropdown",
      // Calcite Maps
      "calcite-maps/calcitemaps-v0.10",

      // Calcite Maps ArcGIS Support
      "calcite-maps/calcitemaps-arcgis-support-v0.10",
      "dojo/domReady!"
    ], function(WebMap, MapView, Home, Zoom, Compass, Search, Legend, LayerList, BasemapToggle, Fullscreen, FeatureLayer, SimpleMarkerSymbol, WFSLayer, TileLayer, ScaleBar, Attribution, watchUtils, Grid, query, arrayUtils, Collapse, Dropdown, CalciteMaps, CalciteMapArcGISSupport) {
      /******************************************************************
       *
       * Create the map, view and widgets
       *
       ******************************************************************/
      // Map
      var GlobalID = "";


      map = new WebMap({ // MODIFIED: Assign to global 'map'
        basemap: "topo"
      });


      // View
      mapView = new MapView({ // MODIFIED: Assign to global 'mapView'
        container: "mapViewDiv",
        map: map,
        padding: {
          top: 50,
          bottom: 0
        },
        // map: map, // removed duplicate map assignment
        center: [-111.3, 39.4],
        zoom: 7,
        scale: 4600000,
        ui: {components: []},
        popup: {
            dockEnabled: true,
            dockOptions: { // Defined dockOptions here
              buttonEnabled: false
            }
        }
      });

      // mapView.popup.dockOptions = { // This is now defined above
      //   // Disable the dock button so users cannot undock the popup
      //   buttonEnabled: false,
      // };

      fullscreen = new Fullscreen({
        view: mapView
      });


      // ------------------------------------ load map layers -------------------------------------

      // MODIFIED: Moved mapLayer creation/adding to addSecureLayers function
      // It will be called by continueMapInitialization after token fetch attempt


      const renderer = {
        type: "unique-value",  // autocasts as new UniqueValueRenderer()
        field: "exploration_method",
        uniqueValueInfos: [
          {value:"Drill", label:"Drill", symbol:{type:"simple-marker", color: [255, 0, 0], style: "circle", outline: {width: 0}, size: 6}},  // Solid Red
          {value:"Excavation", label:"Trench", symbol:{type:"simple-marker", color: [0, 0, 255], style: "circle", outline: {width: 0}, size: 6}},  // Solid Blue
          {value:"CPT", label:"Cone Penetration Test", symbol:{type:"simple-marker", color: [128, 0, 128], style: "circle", outline: {width: 0}, size: 6}}  // Solid Purple
        ]
      };


      var layer = new WFSLayer({
          url: "https://ugs-geoserver-prod-flbcoqv7oa-uc.a.run.app/geoserver/wfs",
          name: "borehole_locations",
          namespaceUri: "hazards",
          id: "locations",
          outFields: ["*"],
          opacity: 0.8,
          title: "Geotechnical Explorations",
          renderer: renderer,
        });
      map.add(layer);


    // show or hide any open calicite panels when user clicks for attribute details
    function showHideCalcitePanels(showPanel, showCollapse) {
        // hide all windows
        query(".panel.in").removeClass("in"); //close any open panels
        query(".panel-collapse").removeClass("in");

        // if specified show this calcite panel
        if (showPanel) {
            //query(showPanel).query(showCollapse).addClass("in");
            query(showPanel).collapse("show"); // so I use these instead
            query(showCollapse).collapse("show");
        }
    }


    var popupAction = {
      title: "Get  Geotechnical Data",
      id: "sample-data",
      className: "esri-icon-table"
    };

    var popupTemplate = {
          outFields: ["*"],
          actions: [popupAction],
          //title: "<b>Associated Data</b>",
          content: createPopup
    }
    layer.popupTemplate = popupTemplate;


    // create popup template content for use clicks
    function createPopup(featureSet){
      var content = "";
      // MODIFIED: Changed showHide params slightly - ensure panelData exists and is correct target
      showHideCalcitePanels("#panelData", "#collapseData");

        var att = featureSet.graphic.attributes;

        if(att.project_name){
             content += "<span class='bold' title='Project Name'>Project Name: </span>" + att.project_name + "<br/>";
        }
        if(att.consultant){
             content += "<span class='bold' title='Consultant'>Consultant: </span>" + att.consultant + "<br/>";
        }
        if(att.date_completed){
              var date = new Date(att.date_completed);
              if (date && !isNaN(date)) date = date.toDateString(); else date = "N/A"; // Added validity check
             content += "<span class='bold' title='Date Completed'>Date Completed: </span>" + date + "<br/>";
        }
        if(att.exploration_method){
             content += "<span class='bold' title='Exploration Method'>Exploration Method: </span>" + att.exploration_method + "<br />";
        }
        if(att.gw_depth){
             content += "<span class='bold' title='Groundwater Depth (ft):'>Groundwater Depth (ft): </span>" + att.gw_depth + "<br />";
        }
        if(att.bedrock_refusal){
             content += "<span class='bold' title='Refusal Depth (ft)'>Refusal Depth (ft): </span>" + att.bedrock_refusal + "<br />";
        }
        if(att.completion){
             content += "<span class='bold' title='Completion'>Completion: </span>" + att.completion + "<br />";
        }
        if(att.latitude && att.longitude){ // Added check for both
             content += "<span class='bold' title='Location: '>Location: </span>" +att.latitude+ ", "+att.longitude+"<br />";
        }
        if(att.elevation_ft){
             content += "<span class='bold' title='Elevation (ft)'>Elevation (ft): </span>" + att.elevation_ft + "<br />";
        }
        if(att.geologic_unit){
             content += "<span class='bold' title='Geologic Unit (ft)'>Geologic Unit: </span>" + att.geologic_unit + "<br />";
        }
        if(att.databasedate){
              var date2 = new Date(att.databasedate);
              if (date2 && !isNaN(date2)) date2 = date2.toDateString(); else date2 = "N/A"; // Added validity check
             content += "<span class='bold' title='Added to Database: '>Added to Database: </span>" + date2 + "<br />";
        }
        if(att.report_url){
             content += "<span class='bold' title='Report URL'>Report URL: </span> <a target='blank' href='" + att.report_url + "'>External Link</a><br />";
        }

        return content;
      }

      function stringToDate(_date,_format,_delimiter){
        var formatLowerCase=_format.toLowerCase();
        var formatItems=formatLowerCase.split(_delimiter);
        var dateItems=_date.split(_delimiter);
        var monthIndex=formatItems.indexOf("mm");
        var dayIndex=formatItems.indexOf("dd");
        var yearIndex=formatItems.indexOf("yyyy");
        var month=parseInt(dateItems[monthIndex]);
        month-=1;
        var formatedDate = new Date(dateItems[yearIndex],month,dateItems[dayIndex]);
        return formatedDate;
      }

      // get the object id of the SELECTED feature  (since trigger actions get id's of ALL nearby ftrs)
      watchUtils.when(mapView.popup, "selectedFeature", function species(evt) {
        if (mapView.popup.selectedFeature && mapView.popup.selectedFeature.attributes) { // Added null check
            GlobalID = mapView.popup.selectedFeature.attributes.boreid;
             console.log("Selected Feature BoreID:", GlobalID);
        } else {
            GlobalID = null; // Reset if no feature selected
            console.log("No feature selected or attributes missing.");
        }
      }); // end watchUtil

      mapView.popup.on("trigger-action", function(event) {
          if (event.action.id === "sample-data") {
            console.log("Trigger action 'sample-data' firing...");
            if (GlobalID) { // Check if GlobalID is set
                 console.log("Querying related data for BoreID:", GlobalID);
                 queryRelated(GlobalID);
            } else {
                console.error("Cannot query related data: No BoreID selected (GlobalID is null).");
                // Optionally inform the user
                alert("Please select a feature point first to get related data.");
            }
          }
      });


// Modified queryRelated function using fetch
function queryRelated(id) {
  if (!id) {
      console.error("queryRelated called with invalid ID:", id);
      alert("An error occurred. Cannot retrieve data without a valid ID.");
      return;
  }
  console.log("Executing queryRelated for BoreID:", id);
  showLoading("Fetching related data..."); // Show loading indicator

  const headers = {
    'Accept-Profile': 'boreholes' // Ensure this profile exists or remove if not needed
  };
  const baseUrl = "https://postgrest-seamlessgeolmap-734948684426.us-central1.run.app";

  // Clear previous data
  $('#projectDetails').empty().html("<i>Loading project details...</i>");
  $('#unitData').empty().html("<i>Loading unit summary...</i>");
  $('#unitDataExpand').empty().html("<i>Loading unit details...</i>");
  $('#samplingData').empty().html("<i>Loading sampling summary...</i>");
  $('#samplingDataExpand').empty().html("<i>Loading sampling details...</i>");
  showHideCalcitePanels("#panelData", "#collapseData"); // Show the panel

  // Use Promise.allSettled to wait for all fetches, even if some fail
  Promise.allSettled([
    // #1 get the rest of the data from the main table
    fetch(`${baseUrl}/borehole_locations?boreid=eq.${id}`, { headers }).then(res => res.ok ? res.json() : Promise.reject(new Error(`Workspace borehole_locations failed: ${res.statusText}`))),
    // #2 get the UNIT DATA
    fetch(`${baseUrl}/borehole_unit_table?boreid=eq.${id}`, { headers }).then(res => res.ok ? res.json() : Promise.reject(new Error(`Workspace borehole_unit_table failed: ${res.statusText}`))),
    // #3 get the BORE SAMPLE DATA
    fetch(`${baseUrl}/borehole_sample_table?boreid=eq.${id}`, { headers }).then(res => res.ok ? res.json() : Promise.reject(new Error(`Workspace borehole_sample_table failed: ${res.statusText}`)))
  ])
  .then(results => {
    // Process Project Details (results[0])
    if (results[0].status === 'fulfilled' && results[0].value.length > 0) {
        const att = results[0].value[0];
        let fields = "";
        if (att.projectid) fields += "<span class='field-heading'>Project ID: </span><span class='field-data'>" + check(att.projectid) + "</span><br>";
        if (att.udot_pin) fields += "<span class='field-heading'>UDOT Pin: </span><span class='field-data'>" + check(att.udot_pin) + "</span><br>";
        if (att.exploration_type) fields += "<span class='field-heading'>Exploration Type: </span><span class='field-data'>" + check(att.exploration_type) + "</span><br>";
        if (att.exploration_equiptment) fields += "<span class='field-heading'>Exploration Equipment: </span><span class='field-data'>" + check(att.exploration_equiptment) + "</span><br>";
        if (att.hammer_type) fields += "<span class='field-heading'>SPT Hammer Type: </span><span class='field-data'>" + check(att.hammer_type) + "</span><br>";
        if (att.coordinate_source) fields += "<span class='field-heading'>Coordinate Source: </span><span class='field-data'>" + check(att.coordinate_source) + "</span><br>";
        if (att.elevation_source) fields += "<span class='field-heading'>Elevation Source: </span><span class='field-data'>" + check(att.elevation_source) + "</span><br>";
        if (att.enteredby) fields += "<span class='field-heading'>Entered By: </span><span class='field-data'>" + check(att.enteredby) + "</span><br>";
        if (att.ugs_gdid) fields += "<span class='field-heading'>UGS GID: </span><span class='field-data'>" + check(att.ugs_gdid) + "</span><br>";
        if (att.boreid) fields += "<span class='field-heading'>BoreID: </span><span class='field-data'>" + check(att.boreid) + "</span><br>";
        if (att.notes) fields += "<span class='field-heading'>Exploration Notes: </span><span class='field-data'>" + check(att.notes) + "</span><br>";
        $('#projectDetails').empty().append(fields || "<i>No project details found.</i>");
    } else {
        $('#projectDetails').empty().html("<i>Error loading project details or no data found.</i>");
        console.error("Project Details Fetch Error:", results[0].reason || "No data");
    }

    // Process Unit Data (results[1])
    if (results[1].status === 'fulfilled' && results[1].value.length > 0) {
        const unitResults = results[1].value;
        let fields = "";
        fields += "<span class='field-heading'>Total Units: </span> <span class='field-data'>" + unitResults.length + " </span><br>";
        const uscsOrgs = [...new Set(unitResults.map(r => r.uscs).filter(Boolean))]; // Filter out null/empty
        fields += "<span class='field-heading'>USCS Identified: </span> <span class='field-data'>" + (uscsOrgs.length > 0 ? uscsOrgs.join(", ") : "N/A") + " </span><br>";
        const maxDepthArray = unitResults.map(r => Number(r.lowerdepth)).filter(n => !isNaN(n));
        const maxdp = maxDepthArray.length > 0 ? Math.max(...maxDepthArray) : "N/A";
        fields += "<span class='field-heading'>Maximum Depth: </span> <span class='field-data'>" + (maxdp !== "N/A" ? maxdp + " ft" : "N/A") + "</span><br>";
        $('#unitData').empty().append(fields);

        let fields2 = "";
        unitResults.forEach(att => {
            fields2 += "<div class='ibox'>";
            if (att.unitname) fields2 += "<span class='field-heading-sm'>Unit Name: </span> <span class='field-data-sm'>" + check(att.unitname) + " | </span>";
            if (att.upperdepth !== null || att.lowerdepth !== null) {
                const upper = att.upperdepth === 0 ? "0" : check(att.upperdepth);
                fields2 += "<span class='field-heading-sm'>Depth: </span> <span class='field-data-sm'>" + upper + "-" + check(att.lowerdepth) + "ft | </span>";
            }
            if (att.uscs) fields2 += "<span class='field-heading-sm'>USCS: </span> <span class='field-data-sm'>" + check(att.uscs) + " | </span>";
            if (att.fieldmoisture) fields2 += "<span class='field-heading-sm'>Moisture: </span> <span class='field-data-sm'>" + check(att.fieldmoisture) + " | </span>";
            if (att.fieldcolor) fields2 += "<span class='field-heading-sm'>Color: </span> <span class='field-data-sm'>" + check(att.fieldcolor) + " | </span>";
            if (att.fielddensity) fields2 += "<span class='field-heading-sm'>Density: </span> <span class='field-data-sm'>" + check(att.fielddensity) + " | </span>";
            if (att.fieldconsistency) fields2 += "<span class='field-heading-sm'>Consistency: </span> <span class='field-data-sm'>" + check(att.fieldconsistency) + " | </span>";
            if (att.notes) fields2 += "<br><span class='field-heading-sm'>Unit Notes: </span> <span class='field-data-sm'>" + check(att.notes) + " </span>";
            fields2 += "</div><br>";
        });
        $('#unitDataExpand').empty().append(fields2 || "<i>No detailed unit data found.</i>");
    } else {
        $('#unitData').empty().html("<i>Error loading unit data or no data found.</i>");
        $('#unitDataExpand').empty().html("<i>Error loading unit data or no data found.</i>");
        console.error("Unit Data Fetch Error:", results[1].reason || "No data");
    }

    // Process Sampling Data (results[2])
    if (results[2].status === 'fulfilled' && results[2].value.length > 0) {
        const sampleResults = results[2].value;
        let fields = "";
        fields += "<span class='field-heading'>Total Samples: </span> <span class='field-data'>" + sampleResults.length + " </span><br>";
        const sampleTypes = [...new Set(sampleResults.map(r => r.samplemethod).filter(Boolean))];
        fields += "<span class='field-heading'>Sample Types: </span> <span class='field-data'>" + (sampleTypes.length > 0 ? sampleTypes.join(", ") : "N/A") + " </span><br>";

        const nValues = sampleResults.map(r => Number(r.nvalue)).filter(n => !isNaN(n));
        if (nValues.length > 0) {
             const minN = Math.min(...nValues);
             const maxN = Math.max(...nValues);
             fields += "<span class='field-heading'>N-Value Range: </span> <span class='field-data'>" + minN + "-" + maxN + " blows/ft</span><br>";
        } else {
             fields += "<span class='field-heading'>N-Value Range: </span> <span class='field-data'>N/A</span><br>";
        }

        // Helper for Yes/No checks
        const checkExists = (arr, keys) => arr.some(item => keys.some(key => item[key]));
        fields += "<span class='field-heading'>Grain Size %: </span> <span class='field-data'>" + (checkExists(sampleResults, ['gravel_percent', 'sand_percent', 'fines_percent']) ? "Yes" : "No Data") + "</span><br>";
        fields += "<span class='field-heading'>Moisture/Density: </span> <span class='field-data'>" + (checkExists(sampleResults, ['labmoisture_percent', 'labdrydensity_pcf']) ? "Yes" : "No Data") + "</span><br>";
        fields += "<span class='field-heading'>Atterberg Limits: </span> <span class='field-data'>" + (checkExists(sampleResults, ['pl', 'll', 'pi']) ? "Yes" : "No Data") + "</span><br>";
        fields += "<span class='field-heading'>Consolidation: </span> <span class='field-data'>" + (checkExists(sampleResults, ['sct_dry_percent', 'sct']) ? "Yes" : "No Data") + "</span><br>";
        fields += "<span class='field-heading'>Shear Data: </span> <span class='field-data'>" + (checkExists(sampleResults, ['shear_type', 'shearangle_degree', 'shearcohesion_psi']) ? "Yes" : "No Data") + "</span><br>";
        fields += "<span class='field-heading'>Chemical Results: </span> <span class='field-data'>" + (checkExists(sampleResults, ['resistivity_ohm_cm', 'sulfates_ppm', 'chlorides_ppm', 'organics_percent_weight', 'ph']) ? "Yes" : "No Data") + "</span><br>";
        fields += "<span class='field-heading'>Sample Notes: </span> <span class='field-data'>" + (checkExists(sampleResults, ['notes']) ? "Yes" : "No Data") + "</span>";
        $('#samplingData').empty().append(fields);

        let fields3 = "";
        sampleResults.forEach(att => {
            fields3 += "<div class='ibox'>";
            if (att.samplenumber) fields3 += "<span class='field-heading-sm'>Sample #: </span> <span class='field-data-sm'>" + check(att.samplenumber) + "</span> | ";
            if (att.samplelower_depth !== null || att.sampleupperdepth !== null) fields3 += "<span class='field-heading-sm'>Depth: </span> <span class='field-data-sm'>" + check(att.sampleupperdepth) + "-" + check(att.samplelower_depth) + " ft</span> | "; // Corrected order
            if (att.samplemethod) fields3 += "<span class='field-heading-sm'>Method: </span> <span class='field-data-sm'>" + check(att.samplemethod) + "</span> | ";
            if (att.nvalue !== null) fields3 += "<span class='field-heading-sm'>N: </span> <span class='field-data-sm'>" + check(att.nvalue) + "</span> | ";
            if (att.gravel_percent !== null) fields3 += "<span class='field-heading-sm'>Gravel%: </span> <span class='field-data-sm'>" + check(att.gravel_percent) + "</span> | ";
            if (att.sand_percent !== null) fields3 += "<span class='field-heading-sm'>Sand%: </span> <span class='field-data-sm'>" + check(att.sand_percent) + "</span> | ";
            if (att.fines_percent !== null) fields3 += "<span class='field-heading-sm'>Fines%: </span> <span class='field-data-sm'>" + check(att.fines_percent) + "</span> | ";
            if (att.labmoisture_percent !== null) fields3 += "<span class='field-heading-sm'>Moisture%: </span> <span class='field-data-sm'>" + check(att.labmoisture_percent) + "</span> | "; // Corrected field name
            if (att.labdrydensity_pcf !== null) fields3 += "<span class='field-heading-sm'>Dry Density(pcf): </span> <span class='field-data-sm'>" + check(att.labdrydensity_pcf) + "</span> | "; // Corrected field name
            if (att.ll !== null) fields3 += "<span class='field-heading-sm'>LL: </span> <span class='field-data-sm'>" + check(att.ll) + "</span> | ";
            if (att.pl !== null) fields3 += "<span class='field-heading-sm'>PL: </span> <span class='field-data-sm'>" + check(att.pl) + "</span> | ";
            if (att.pi !== null) fields3 += "<span class='field-heading-sm'>PI: </span> <span class='field-data-sm'>" + check(att.pi) + "</span> | ";
            if (att.sct !== null) fields3 += "<span class='field-heading-sm'>Consolidation%: </span> <span class='field-data-sm'>" + check(att.sct) + "</span> | ";
            if (att.sct_dry_percent !== null) fields3 += "<span class='field-heading-sm'>Dry Consolidation%: </span> <span class='field-data-sm'>" + check(att.sct_dry_percent) + "</span> | ";
            if (att.shear_type) fields3 += "<span class='field-heading-sm'>Shear Type: </span> <span class='field-data-sm'>" + check(att.shear_type) + "</span> | ";
            if (att.shearangle_degree !== null) fields3 += "<span class='field-heading-sm'>Angle(°): </span> <span class='field-data-sm'>" + check(att.shearangle_degree) + "</span> | ";
            if (att.shearcohesion_psi !== null) fields3 += "<span class='field-heading-sm'>Cohesion(psi): </span> <span class='field-data-sm'>" + check(att.shearcohesion_psi) + "</span> | ";
            if (att.resistivity_ohm_cm !== null) fields3 += "<span class='field-heading-sm'>Resistivity(Ω·cm): </span> <span class='field-data-sm'>" + check(att.resistivity_ohm_cm) + "</span> | ";
            if (att.sulfates_ppm !== null) fields3 += "<span class='field-heading-sm'>Sulfates(ppm): </span> <span class='field-data-sm'>" + check(att.sulfates_ppm) + "</span> | ";
            if (att.chlorides_ppm !== null) fields3 += "<span class='field-heading-sm'>Chlorides(ppm): </span> <span class='field-data-sm'>" + check(att.chlorides_ppm) + "</span> | ";
            if (att.organics_percent_weight !== null) fields3 += "<span class='field-heading-sm'>Organics(%wt): </span> <span class='field-data-sm'>" + check(att.organics_percent_weight) + "</span> | ";
            if (att.ph !== null) fields3 += "<span class='field-heading-sm'>pH: </span> <span class='field-data-sm'>" + check(att.ph) + "</span> | ";
            if (att.notes) fields3 += "<br><span class='field-heading-sm'>Sample Notes: </span> <span class='field-data-sm'>" + check(att.notes) + "</span>";
            fields3 += "</div><br>";
        });
        $('#samplingDataExpand').empty().append(fields3 || "<i>No detailed sampling data found.</i>");
    } else {
        $('#samplingData').empty().html("<i>Error loading sampling data or no data found.</i>");
        $('#samplingDataExpand').empty().html("<i>Error loading sampling data or no data found.</i>");
        console.error("Sampling Data Fetch Error:", results[2].reason || "No data");
    }
  })
  .finally(() => {
      hideLoading(); // Hide loading indicator regardless of success/failure
  });
} // end queryRelated Function


      // check values if null/undefined
      function check(val){
        // Check for null, undefined, or empty string
        if (val === null || typeof val === 'undefined' || val === "") {
          return " "; // Return a space or perhaps "N/A"
        }
        return val; // Return the original value if it's valid
      }


      // Popup and panel sync
      mapView.when(function() {
        CalciteMapArcGISSupport.setPopupPanelSync(mapView);
      });


      // Watching for map extent changes and updating feature count
      // Using watchUtils.whenFalseOnce to query only when the view stops updating
      watchUtils.whenFalseOnce(mapView, "updating", function() {
          queryAndUpdateFeatureCount(); // Initial query
      });

      // Also trigger query when view becomes stationary after interaction
      watchUtils.whenTrue(mapView, "stationary", function() {
          queryAndUpdateFeatureCount();
      });

      function queryAndUpdateFeatureCount() {
          console.log("Querying feature count for current extent...");
          // Create query parameters for visible features
          const queryParams = layer.createQuery(); // Use createQuery for WFSLayer
          queryParams.geometry = mapView.extent;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = false; // Not needed for count
          queryParams.where = "1=1"; // Ensure all features within extent are considered

          // Query the WFS layer for features (WFSLayer doesn't have queryFeatureCount directly)
          layer.queryFeatures(queryParams)
            .then(function(featureSet) {
              const count = featureSet.features.length;
              let displayCount = count;
              if (count >= 1000) { // Adjust threshold if needed
                displayCount = "1000+";
              }
              document.getElementById('statsDiv').innerHTML = "Visible Features: " + displayCount;
              console.log("Visible feature count:", count);
            })
            .catch(function(error) {
              console.error("Error getting feature count:", error);
              document.getElementById('statsDiv').innerHTML = "Count Unavailable";
            });
      }



      // Search - add to navbar
      var searchWidget = new Search({
        container: "searchWidgetDiv",
        view: mapView,
        includeDefaultSources: false, // suppress auto locator (search places appears as a default)
        locationEnabled: true,  //default true
        minSuggestCharacters: 3,    //start giving suggestions at 3
        maxSuggestions: 20,
        maxResults: 30,     //default 6
        searchAllEnabled: false,   //default is true
        sources: [{
              layer: layer, // Search the WFSLayer
              autoNavigate: true, //don't auto zoom in on the feature  //default true
              searchFields: ["boreid", "project_name", "projectid"],
              displayField: "boreid", // Display BoreID in suggestions/results
              exactMatch: false,
              name: "Borehole ID/Project Name",
              placeholder: "Search BoreID or Project Name", // Updated placeholder
              popupEnabled: true,
              outFields: ["*"],
              popupTemplate: popupTemplate,
              zoomScale: 5000, // Zoom closer on search result
              resultSymbol: {
                  type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
                  style: "circle",
                  color: [255, 255, 0, 0.8], // Yellow, slightly transparent
                  size: "12px",
                  outline: {
                    // autocasts as new SimpleLineSymbol()
                    color: [0, 0, 0, 0.8], // Black outline
                    width: 1.5
                  }
                },
          }]
      });
      CalciteMapArcGISSupport.setSearchExpandEvents(searchWidget);


      // Map widgets
      var home = new Home({ view: mapView });
      mapView.ui.add(home, "top-left");
      var zoom = new Zoom({ view: mapView });
      mapView.ui.add(zoom, "top-left");
      var compass = new Compass({ view: mapView });
      mapView.ui.add(compass, "top-left");

      var basemapToggle = new BasemapToggle({ view: mapView, secondBasemap: "satellite" });
      mapView.ui.add(basemapToggle, "bottom-right");

      var scaleBar = new ScaleBar({ view: mapView });
      mapView.ui.add(scaleBar, "bottom-left");
      var attribution = new Attribution({ view: mapView });
      mapView.ui.add(attribution, "manual");

      // Panel widgets - add legend
      var legendWidget = new Legend({
        container: "legendDiv",
        view: mapView,
        layerInfos: [{
          layer: layer, // Legend for WFSLayer
          title: "Exploration Method"
        }]
      });

      // Panel widgets - add layers
      var layerListWidget = new LayerList({ // Renamed variable for clarity
        container: "layersDiv",
        view: mapView
      });


      // MODIFIED: Initialize Firebase after basic map setup
      // The Firebase initialization script (module) will call window.initializeFirebase
      // which is defined above this require block.


    }); // End main require block
  </script>

</body>
</html>