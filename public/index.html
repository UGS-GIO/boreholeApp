<!DOCTYPE html>
<html>
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PPGF6Z2N');</script>
  <!-- End Google Tag Manager -->

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="Subsurface Geotechnical Database - Utah Geological Survey">
 
  <title>Subsurface Geotechnical Database</title>

  <!-- Calcite Maps Bootstrap -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-bootstrap.min-v0.10.css">
  
  <!-- Calcite Maps -->
  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.10.css">

  <!-- ArcGIS JS 4 -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/css/main.css">
   
  <!-- Boilerplate Template Style sheet -->
  <link rel="stylesheet" href="/apps/_ugsmaptemplate/template.css">

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
    
    h2 {
      font-size: 20px;
    }

    .ibox{
      outline: 1px solid #e2e8f3;
      padding: 4px;
    }

    .calcite-title:before {
      content: url('https://geology.utah.gov/apps/_ugsmaptemplate/logo_main.png');
      padding: 6px 12px 0 2px;
      cursor: pointer;
    }

    .esri-feature__content-element {
      padding: 0 0 0 0;
    }
    
    .esri-popup__inline-actions-container>.esri-popup__action, 
    .esri-popup__inline-actions-container>.esri-popup__action-toggle {
      margin: 0 7px;
      max-width: 100%;
    }
    
    .esri-popup__inline-actions-container:only-child>.esri-popup__action, 
    .esri-popup__inline-actions-container:only-child>.esri-popup__action-toggle {
      max-width: 100%;
    }
    
    .esri-layer-list__item-actions-menu-item--active, 
    .esri-layer-list__item-actions-menu-item--active:hover {
      background-color: #ffffff;
    }

    .field-heading {
      font: 600 12px Georgia, serif;
    }
    
    .field-data {
      font: 12px Georgia, serif;
    }

    .field-heading-sm {
      font: 600 11px Georgia, serif;
    }
    
    .field-data-sm {
      font: 11px Georgia, serif;
    }
	
	  .esri-legend__layer-caption {
		  display: none;
	  }

    #statsDiv {
      position: absolute;
      bottom: 30px;
      left: 20px;
      color: black;
      font-size: 14px;
      font-weight: 700;
    }
    
    .bold{
      font-weight: 600;
    }
    
    .page-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 5px;
      text-align: center;
    }
  </style>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>

  <!-- Authentication and Token Handling -->
  <script type="text/javascript">
    // Global variables for token and map management
    let arcgisToken = null;
    let mapLayer = null;
    let mapInitialized = false;
    const projectName = 'https://us-central1-ut-dnr-ugs-geolmapportal-prod.cloudfunctions.net';
    
    // Initialize Firebase and start auth process immediately on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Starting Firebase initialization');
      
      // Add loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'page-loading';
      loadingDiv.innerHTML = '<div><h3>Loading map...</h3><p><small>Initializing services...</small></p></div>';
      document.body.appendChild(loadingDiv);
      
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAi0ecBg7dfitM9Num5n7onxZATDSPaC_o",
        authDomain: "ut-dnr-ugs-borehole-prod.firebaseapp.com",
        projectId: "ut-dnr-ugs-borehole-prod",
        storageBucket: "ut-dnr-ugs-borehole-prod.appspot.com",
        messagingSenderId: "78333091254",
        appId: "1:78333091254:web:993c44895c1ea385dc3517",
        measurementId: "G-QP1XVRTH4Q"
      };

      try {
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        console.log("Firebase initialized successfully");
        
        // Start authentication immediately
        initAuth();
      } catch (error) {
        console.error("Firebase initialization error:", error);
        updateLoadingStatus('Authentication Error', 'Failed to initialize Firebase. Some features may be limited.');
        // Continue without Firebase
        window.initialArcGISToken = null;
        loadArcGISAPI();
      }
    });

    // Initialize authentication
    function initAuth() {
      const auth = firebase.auth();
      
      auth.onAuthStateChanged(function(user) {
        if (user) {
          console.log('User signed in:', user.uid);
          updateLoadingStatus('Loading map...', 'Authenticating map services...');
          getArcGISToken();
        } else {
          console.log('No user signed in, signing in anonymously...');
          auth.signInAnonymously()
            .catch(function(error) {
              console.error('Anonymous sign-in error:', error);
              updateLoadingStatus('Authentication Error', 'Failed to sign in. Some features may be limited.');
              // Continue without authentication
              window.initialArcGISToken = null;
              loadArcGISAPI();
            });
        }
      });
    }

    // Get ArcGIS token
    function getArcGISToken() {
  try {
    // Get functions instance for the CURRENT project (borehole-prod)
    const functions = firebase.functions(); // Use compat version
    // No need to set customDomain here

    // Call the PROXY function within borehole-prod
    updateLoadingStatus('Loading map...', 'Requesting secure token...'); // Update status
    const proxyGetArcGISTokenFn = functions.httpsCallable('proxyGetArcGISToken');

    proxyGetArcGISTokenFn()
      .then(function(result) {
        arcgisToken = result.data.token; // Token comes from the proxy now
        console.log('ArcGIS token received via proxy:', arcgisToken ? 'Token received successfully' : 'No token received');
        console.log('>>> Actual Token String:', token);
        window.initialArcGISToken = arcgisToken;
        updateLoadingStatus('Loading map...', 'Initializing map components...');
        loadArcGISAPI(); // Proceed to load ArcGIS API
      })
      .catch(function(error) {
        // Handle errors returned from the proxy function
        console.error('Error getting ArcGIS token via proxy:', error.code, error.message, error.details);
        updateLoadingStatus('Authentication Warning', `Could not get token: ${error.message}. Some features may be limited.`);

        window.initialArcGISToken = null;
        loadArcGISAPI(); // Proceed without token
      });
  } catch (error) {
    console.error('Error setting up token function call:', error);
    updateLoadingStatus('Service Error', 'Failed to connect to authentication service. Some features may be limited.');

    window.initialArcGISToken = null;
    loadArcGISAPI(); // Proceed without token
  }
}

    // Load ArcGIS JavaScript API
    function loadArcGISAPI() {
      console.log('Loading ArcGIS JS API with token:', window.initialArcGISToken ? 'Available' : 'Not available');
      // ArcGIS initialization will happen through the require statement which will use window.initialArcGISToken
    }

    // Update loading status display
    function updateLoadingStatus(title, message) {
      const loadingDiv = document.querySelector('.page-loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = `<div><h3>${title}</h3><p><small>${message}</small></p></div>`;
      }
    }

    // Helper function to remove loading indicator when map is ready
    function removeLoadingIndicator() {
      const loadingDiv = document.querySelector('.page-loading');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }

   
  </script>

  <!-- ArcGIS Configuration -->
  <script type="text/javascript">
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: "https://esri.github.io/calcite-maps/dist/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: "https://esri.github.io/calcite-maps/dist/js/dojo"
      }]
    };
  </script>
</head>

<body class="calcite-maps calcite-nav-top">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PPGF6Z2N"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- jQuery (for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <!-- Navbar -->
  <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
    <!-- Menu -->
    <div class="dropdown calcite-dropdown calcite-text-dark calcite-bg-light" role="presentation">
      <a class="dropdown-toggle" role="menubutton" aria-haspopup="true" aria-expanded="false" tabindex="0">
        <div class="calcite-dropdown-toggle">
          <span class="sr-only">Toggle dropdown menu</span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </a>
      <ul class="dropdown-menu" role="menu">
        <li><a role="menuitem" tabindex="0" data-target="#panelInfo" aria-haspopup="true"><span class="glyphicon glyphicon-info-sign"></span> About</a></li>
        <li><a role="menuitem" tabindex="0" href="#" data-target="#panelLegend" aria-haspopup="true"><span class="glyphicon glyphicon-list-alt"></span> Legend</a></li>
        <li><a role="menuitem" tabindex="0" href="#" data-target="#panelLayers" aria-haspopup="true"><span class="glyphicon glyphicon-list-alt"></span> Layers</a></li>
      </ul>
    </div>
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
      <span class="calcite-title-main" style="color: white;">
        <a href="https://geology.utah.gov" style="color: white;">Utah Geological Survey</a>
      </span>
      <span class="calcite-title-divider hidden-xs"></span>
      <span class="calcite-title-sub hidden-xs" id="subTitle"> </span>
      <span class="calcite-title-sub hidden-xs" id="subTitle">Subsurface Geotechnical Database</span>
    </div>
    <!-- Nav -->
    <ul class="nav navbar-nav calcite-nav">
      <li>
        <div class="calcite-navbar-search calcite-search-expander">
          <div id="searchWidgetDiv"></div>
        </div>
      </li>
    </ul>
  </nav>

  <!-- Map -->
  <div class="calcite-map calcite-map-absolute">
    <div id="mapViewDiv"></div>
    <div id="statsDiv"></div>
  </div>

  <!-- Panels -->
  <div class="calcite-panels calcite-panels-right calcite-text-light calcite-bg-dark panel-group">
    <!-- Panel - About -->
    <div id="panelInfo" class="panel collapse in">
      <div id="headingInfo" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseInfo" aria-expanded="true" aria-controls="collapseInfo"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span><span class="panel-label">About</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelInfo"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a>  
        </div>
      </div>
      <div id="collapseInfo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingInfo">
        <div class="panel-body">
          <p><strong>Subsurface Geotechnical Database</strong></p>
          <p>
            This map shows a digital database of subsurface geologic data extracted from the <a target="_blank" style="color:blue;" href="https://geodata.geology.utah.gov/">UGS GeoData Archive</a>, a repository of generally unpublished data collected over decades by the UGS. The purpose of this map is to provide important information on the subsurface conditions and geology to support geologic and geotechnical investigations and other projects to complement existing geologic, geologic hazard, and other maps and data. 
            <br><br>In a partnership with the Utah Department of Transportation (UDOT) and the U.S. Geological Survey, the UGS has made the geologic data within the archive more accessible for public use and further analysis. Relevant subsurface data have been extracted from the archived geotechnical and related reports, and each exploration location (borings, test pits, sample locations, etc.) is geolocated, as represented by colored points on this map. The data include information about the exploration location, descriptive soil units encountered, and soil sample and laboratory test data. Access to digital copies of the original reports is also provided when viewing borehole point data. Use the mouse to zoom to the area of interest then left click on a point to select the exploration location and view information about that location.
            <br><br>Extraction of geologic data from the Geodata Archive is ongoing and this map will be updated periodically. These data will form the first phase of development of a three-dimensional geologic database of Utah. We welcome donations of geologic reports and/or data we do not currently have in the archive, particularly development-related geotechnical reports, to further enhance the database and its usefulness.   
          </p>
        </div>
      </div>
    </div>

    <!-- Panel - Legend -->
    <div id="panelLegend" class="panel collapse">
      <div id="headingLegend" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseLegend" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><span class="panel-label">Legend</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelLegend"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a> 
        </div>
      </div>
      <div id="collapseLegend" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingLegend">
        <div class="panel-body">            
          <div id="legendDiv"></div>
        </div>
      </div>
    </div>

    <!-- Panel - Layers -->
    <div id="panelLayers" class="panel collapse">
      <div id="headingLayers" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseLayers" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><span class="panel-label">Layers</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelLayers"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a> 
        </div>
      </div>
      <div id="collapseLayers" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingLayers">
        <div class="panel-body">            
          <div id="layersDiv"></div>
        </div>
      </div>
    </div>

    <!-- Panel - Data -->
    <div id="panelData" class="panel collapse">
      <div id="headingData" class="panel-heading" role="tab">
        <div class="panel-title">
          <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseData" aria-expanded="false" aria-controls="collapseLegend"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><span class="panel-label">Data</span></a> 
          <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelData"><span class="esri-icon esri-icon-close" aria-hidden="true"></span></a> 
        </div>
      </div>
      <div id="collapseData" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingData">
        <div class="panel-body">            
          <div id="dataDiv">
            <h2>Project Details</h2>
            <div id="projectDetails"></div>

            <h2>Unit Data</h2>
            <div id="unitData"></div>
            <button data-toggle="collapse" data-target="#unitDataExpand">Expand Detailed Data</button>
            <div id="unitDataExpand" class="collapse"></div>

            <h2>Sampling Data</h2>
            <div id="samplingData"></div>
            <button data-toggle="collapse" data-target="#samplingDataExpand">Expand Detailed Data</button>
            <div id="samplingDataExpand" class="collapse"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.21/"></script>

  <!-- Map Initialization -->
  <script>

function configureArcGISWithToken(esriConfig, token) {
  if (!token) {
    console.log('No token available for interceptor configuration');
    return;
  }
  console.log(">>> Configuring esriConfig interceptor with token."); // Add log

  // Check if this interceptor already exists to avoid duplicates if refreshed
  const interceptorExists = esriConfig.request.interceptors.items.some(interceptor =>
      interceptor.urls && interceptor.urls.includes("https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer")
  );

  if (!interceptorExists) {
       esriConfig.request.interceptors.push({
        urls: [
          "https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer",
          "https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer/0",
          "https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/30x60_Quads/MapServer"
          ],
          // Function executed BEFORE the request matching 'urls' is sent
          before: function(params) {
            // Ensure the query object exists
            params.requestOptions.query = params.requestOptions.query || {};
            // Add the token parameter
            params.requestOptions.query.token = token;
            console.log(">>> Interceptor adding token to request for:", params.url); // Add log
          },
          // Optional: Add error handling within the interceptor if needed
          // error: function(error, params) { ... }
        });
        console.log(">>> Interceptor added.");
  } else {
      console.log(">>> Interceptor already exists for this URL.");
      // Optional: Consider updating the existing interceptor's token if necessary,
      // but adding duplicates should be avoided. Pushing again might add duplicates.
  }
}
  // Keep the require statement outside, but define the callback separately
let initializeMap; // Declare a variable to hold the map initialization function

require([
    // ... all your existing dependencies ...
    "esri/WebMap", "esri/views/MapView", "esri/config", "esri/widgets/Home",
    "esri/widgets/Zoom", "esri/widgets/Compass", "esri/widgets/Search",
    "esri/widgets/Legend", "esri/widgets/LayerList", "esri/widgets/BasemapToggle",
    "esri/widgets/Fullscreen", "esri/layers/FeatureLayer", "esri/symbols/SimpleMarkerSymbol",
    "esri/layers/WFSLayer", "esri/layers/TileLayer", "esri/widgets/ScaleBar",
    "esri/widgets/Attribution", "esri/core/watchUtils", "dgrid/Grid", "dojo/query",
    "dojo/_base/array", "bootstrap/Collapse", "bootstrap/Dropdown",
    "calcite-maps/calcitemaps-v0.10", "calcite-maps/calcitemaps-arcgis-support-v0.10",
    "dojo/domReady!"
], function(
    // ... all your dependency variables ...
    WebMap, MapView, esriConfig, Home, Zoom, Compass, Search, Legend, LayerList,
    BasemapToggle, Fullscreen, FeatureLayer, SimpleMarkerSymbol, WFSLayer, TileLayer,
    ScaleBar, Attribution, watchUtils, Grid, query, arrayUtils, Collapse, Dropdown,
    CalciteMaps, CalciteMapArcGISSupport
) {
    // Define the map initialization function
    initializeMap = function(token) { // Pass the token in
      console.log('ArcGIS initialization starting with token:', token ? 'Available' : 'Not available');

      // Configure ArcGIS with token if available
      if (token) {
        // Use the passed token directly, no need for window.initialArcGISToken here
        configureArcGISWithToken(esriConfig, token);
      }

      // Map variables
      var GlobalID = "";
      var mapLayer = null; // Keep mapLayer definition local to init

      // Create map
      var map = new WebMap({
        basemap: "topo"
      });

      // Create map view
      var mapView = new MapView({
        container: "mapViewDiv",
        map: map,
        padding: { top: 50, bottom: 0 },
        center: [-111.3, 39.4],
        zoom: 7,
        scale: 4600000,
        ui: { components: [] },
        popup: { dockEnabled: true }
      });

      mapView.popup.dockOptions = { buttonEnabled: false };

      // Fullscreen widget
      var fullscreen = new Fullscreen({ view: mapView });

      // Create the 1:24,000 Geologic Maps layer with token
      // Pass token directly if available
      mapLayer = new TileLayer({
          url: "https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer",
          id: "24k",
          index: 0,
          opacity: 0.7,
          title: "1:24,000 Geologic Maps",
          visible: false,
          legendEnabled: false,
          // Use the passed token here
          customParameters: {
            token: token
          }
      });

      // Add the layer ONLY if a token was successfully passed AND layer was created
      if (token && mapLayer) {
        map.add(mapLayer);
        console.log("Token-secured layer added to map.");
      } else if (!token) {
        console.log("No token available, skipping token-secured layer.");
      } else {
        console.error("Token available but mapLayer failed to initialize?"); // Should not happen
      }


      // ... (rest of your map initialization code: WFS layer, popups, widgets, etc.) ...
      // Make sure to remove any other references to window.initialArcGISToken inside this block

        // Create renderer for WFS layer
      const renderer = {
        type: "unique-value",
        field: "exploration_method",
        uniqueValueInfos: [
          {value:"Drill", label:"Drill", symbol:{type:"simple-marker", color: [255, 0, 0], style: "circle", outline: {width: 0}, size: 6}},
          {value:"Excavation", label:"Trench", symbol:{type:"simple-marker", color: [0, 0, 255], style: "circle", outline: {width: 0}, size: 6}},
          {value:"CPT", label:"Cone Penetration Test", symbol:{type:"simple-marker", color: [128, 0, 128], style: "circle", outline: {width: 0}, size: 6}}
        ]
      };

      // Create WFS layer for borehole locations
      var layer = new WFSLayer({
        url: "https://ugs-geoserver-prod-flbcoqv7oa-uc.a.run.app/geoserver/wfs",
        name: "borehole_locations",
        namespaceUri: "hazards",
        id: "locations",
        outFields: ["*"],
        opacity: 0.8,
        title: "Geotechnical Explorations",
        renderer: renderer,
      });

      // Add the WFS layer to the map
      map.add(layer);

      // Function to show/hide Calcite panels
      function showHideCalcitePanels(showPanel, showCollapse) {
        // Hide all windows
        query(".panel.in").removeClass("in");
        query(".panel-collapse").removeClass("in");

        // Show specified panel if provided
        if (showPanel) {
          query(showPanel).collapse("show");
          query(showCollapse).collapse("show");
        }
      }

      // Define popup action for getting detailed data
      var popupAction = {
        title: "Get Geotechnical Data",
        id: "sample-data",
        className: "esri-icon-table"
      };

      // Create popup template
      var popupTemplate = {
        outFields: ["*"],
        actions: [popupAction],
        content: createPopup
      };

      // Apply popup template to the layer
      layer.popupTemplate = popupTemplate;

      // Create popup content function
      function createPopup(featureSet) {
        var content = "";
        showHideCalcitePanels("", "#collapseData");

        var att = featureSet.graphic.attributes;

        if(att.project_name) {
          content += "<span class='bold' title='Project Name'>Project Name: </span>" + att.project_name + "<br/>";
        }
        if(att.consultant) {
          content += "<span class='bold' title='Consultant'>Consultant: </span>" + att.consultant + "<br/>";
        }
        if(att.date_completed) {
          var date = new Date(att.date_completed);
          if (date) date = date.toDateString();
          content += "<span class='bold' title='Date Completed'>Date Completed: </span>" + date + "<br/>";
        }
        if(att.exploration_method) {
          content += "<span class='bold' title='Exploration Method'>Exploration Method: </span>" + att.exploration_method + "<br />";
        }
        if(att.gw_depth) {
          content += "<span class='bold' title='Groundwater Depth (ft):'>Groundwater Depth (ft): </span>" + att.gw_depth + "<br />";
        }
        if(att.bedrock_refusal) {
          content += "<span class='bold' title='Refusal Depth (ft)'>Refusal Depth (ft): </span>" + att.bedrock_refusal + "<br />";
        }
        if(att.completion) {
          content += "<span class='bold' title='Completion'>Completion: </span>" + att.completion + "<br />";
        }
        if(att.latitude) {
          content += "<span class='bold' title='Location: </span>" + att.latitude + ", " + att.longitude + "<br />";
        }
        if(att.elevation_ft) {
          content += "<span class='bold' title='Elevation (ft)'>Elevation (ft): </span>" + att.elevation_ft + "<br />";
        }
        if(att.geologic_unit) {
          content += "<span class='bold' title='Geologic Unit (ft)'>Geologic Unit: </span>" + att.geologic_unit + "<br />";
        }
        if(att.databasedate) {
          var date2 = new Date(att.databasedate);
          if (date2) date2 = date2.toDateString();
          content += "<span class='bold' title='Added to Database: '>Added to Database: </span>" + date2 + "<br />";
        }
        if(att.report_url) {
          content += "<span class='bold' title='Report URL'>Report URL: </span> <a target='blank' href='" + att.report_url + "'>External Link</a><br />";
        }

        return content;
      }

      // Helper function for date parsing
      function stringToDate(_date, _format, _delimiter) {
        var formatLowerCase = _format.toLowerCase();
        var formatItems = formatLowerCase.split(_delimiter);
        var dateItems = _date.split(_delimiter);
        var monthIndex = formatItems.indexOf("mm");
        var dayIndex = formatItems.indexOf("dd");
        var yearIndex = formatItems.indexOf("yyyy");
        var month = parseInt(dateItems[monthIndex]);
        month -= 1;
        var formatedDate = new Date(dateItems[yearIndex], month, dateItems[dayIndex]);
        return formatedDate;
      }

      // Get the object ID of the selected feature
      watchUtils.when(mapView.popup, "selectedFeature", function(evt) {
          if (mapView.popup.selectedFeature && mapView.popup.selectedFeature.attributes) {
             GlobalID = mapView.popup.selectedFeature.attributes.boreid;
          } else {
             GlobalID = null; // Reset if no feature selected or attributes missing
          }
      });

     // Handle popup action button click
     mapView.popup.on("trigger-action", function(event) {
        if (event.action.id === "sample-data") {
          console.log("Trigger event firing!");
          if (GlobalID) { // Check if GlobalID is set
              console.log(GlobalID);
              queryRelated(GlobalID);
          } else {
              console.log("No feature selected or boreid missing.");
          }
        }
      });

      // Function to query related data
      function queryRelated(id) {
        const headers = {
          'Accept-Profile': 'boreholes'
        };

        // Clear previous data
        $('#projectDetails').empty();
        $('#unitData').empty();
        $('#unitDataExpand').empty().removeClass('in'); // Ensure it's collapsed
        $('#samplingData').empty();
        $('#samplingDataExpand').empty().removeClass('in'); // Ensure it's collapsed

        // Show loading indicator or message in panels
        $('#projectDetails').html('<p>Loading project details...</p>');
        $('#unitData').html('<p>Loading unit data...</p>');
        $('#samplingData').html('<p>Loading sample data...</p>');


        // #1 Get main table data
        fetch(`https://postgrest-seamlessgeolmap-734948684426.us-central1.run.app/borehole_locations?boreid=eq.${id}`, {
          headers: headers
        })
          .then(response => {
              if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
              return response.json();
           })
          .then(results => {
            $('#projectDetails').empty(); // Clear loading message
            if (results.length === 0) {
                 $('#projectDetails').append('<p>No project details found.</p>');
                 return;
            }

            console.log(results[0]);
            var fields = "";
            var att = results[0];

            if (att.projectid) {
              fields += "<span class='field-heading'>Project ID: </span><span class='field-data'>" + check(att.projectid) + "</span><br>";
            }
            if (att.udot_pin) {
              fields += "<span class='field-heading'>UDOT Pin: </span><span class='field-data'>" + check(att.udot_pin) + "</span><br>";
            }
            if (att.exploration_type) {
              fields += "<span class='field-heading'>Exploration Type: </span><span class='field-data'>" + check(att.exploration_type) + "</span><br>";
            }
            if (att.exploration_equiptment) {
              fields += "<span class='field-heading'>Exploration Equipment: </span><span class='field-data'>" + check(att.exploration_equiptment) + "</span><br>";
            }
            if (att.hammer_type) {
              fields += "<span class='field-heading'>SPT Hammer Type: </span><span class='field-data'>" + check(att.hammer_type) + "</span><br>";
            }
            if (att.coordinate_source) {
              fields += "<span class='field-heading'>Coordinate Source: </span><span class='field-data'>" + check(att.coordinate_source) + "</span><br>";
            }
            if (att.elevation_source) {
              fields += "<span class='field-heading'>Elevation Source: </span><span class='field-data'>" + check(att.elevation_source) + "</span><br>";
            }
            if (att.enteredby) {
              fields += "<span class='field-heading'>Entered By: </span><span class='field-data'>" + check(att.enteredby) + "</span><br>";
            }
            if (att.ugs_gdid) {
              fields += "<span class='field-heading'>UGS GID: </span><span class='field-data'>" + check(att.ugs_gdid) + "</span><br>";
            }
            if (att.boreid) {
              fields += "<span class='field-heading'>BoreID: </span><span class='field-data'>" + check(att.boreid) + "</span><br>";
            }
            if (att.notes) {
              fields += "<span class='field-heading'>Exploration Notes: </span><span class='field-data'>" + check(att.notes) + "</span><br>";
            }
            fields += "<br>";

            $('#projectDetails').append(fields);
             showHideCalcitePanels("#panelData", "#collapseData"); // Show panel only after first fetch succeeds
          })
          .catch(error => {
              console.error('Error fetching main table data:', error);
               $('#projectDetails').empty(); // Clear loading message
               $('#projectDetails').append('<p>Error loading project details.</p>');
               showHideCalcitePanels("#panelData", "#collapseData"); // Still show panel on error
           });

        // #2 Get unit data
        fetch(`https://postgrest-seamlessgeolmap-734948684426.us-central1.run.app/borehole_unit_table?boreid=eq.${id}`, {
          headers: headers
        })
          .then(response => {
              if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
              return response.json();
           })
          .then(results => {
            $('#unitData').empty(); // Clear loading message
            $('#unitDataExpand').empty();
            if (results.length === 0) {
                 $('#unitData').append('<p>No unit data found.</p>');
                 return;
            }

            var fields = "";

            // Total number of units
            console.log("UNIT DATA RESULTS");
            console.log(results);
            fields += "<span class='field-heading'>Total Units: </span> <span class='field-data'>" + results.length + " </span><br>";

            // USCS organizations
            var orgs = results.map(result => result.uscs).filter(Boolean).join(", ") || "N/A"; // Filter out null/empty and join
            fields += "<span class='field-heading'>USCS Identified: </span> <span class='field-data'>" + orgs + " </span><br>";


            // Max depth
            var maxarray = results.map(result => Number(result.lowerdepth)).filter(n => !isNaN(n) && Number.isFinite(n));
            var maxdp = maxarray.length > 0 ? Math.max(...maxarray) : "N/A";
            fields += "<span class='field-heading'>Maximum Depth: </span> <span class='field-data'>" + (maxdp !== "N/A" ? maxdp + " ft" : maxdp) + "</span><br>";

            $('#unitData').append(fields);

            var fields2 = "<br>";

            results.forEach(att => {
              fields2 += "<div class='ibox'>";
              if (att.unitname) {
                fields2 += "<span class='field-heading-sm'>Unit Name: </span> <span class='field-data-sm'>" + check(att.unitname) + " | </span>";
              }
               // Ensure depths are treated correctly, especially 0
              const upperDepth = att.upperdepth === 0 ? "0" : check(att.upperdepth);
              const lowerDepth = check(att.lowerdepth);
              if (upperDepth !== " " || lowerDepth !== " ") { // Check if at least one depth exists
                  fields2 += "<span class='field-heading-sm'>Unit Depth: </span> <span class='field-data-sm'>" + upperDepth + "-" + lowerDepth + "ft | </span>";
              }

              if (att.uscs) {
                fields2 += "<span class='field-heading-sm'>USCS: </span> <span class='field-data-sm'>" + check(att.uscs) + " | </span>";
              }
              if (att.fieldmoisture) {
                fields2 += "<span class='field-heading-sm'>Moisture: </span> <span class='field-data-sm'>" + check(att.fieldmoisture) + " | </span>";
              }
              if (att.fieldcolor) {
                fields2 += "<span class='field-heading-sm'>Color: </span> <span class='field-data-sm'>" + check(att.fieldcolor) + " | </span>";
              }
              if (att.fielddensity) {
                fields2 += "<span class='field-heading-sm'>Density: </span> <span class='field-data-sm'>" + check(att.fielddensity) + " | </span>";
              }
              if (att.fieldconsistency) {
                fields2 += "<span class='field-heading-sm'>Consistency: </span> <span class='field-data-sm'>" + check(att.fieldconsistency) + " | </span>";
              }
              if (att.notes) {
                fields2 += "<span class='field-heading-sm'>Unit Notes: </span> <span class='field-data-sm'>" + check(att.notes) + " </span><br>";
              }
              // Remove trailing " | " if present
              if (fields2.endsWith(" | </span>")) {
                  fields2 = fields2.slice(0, -10) + "</span>";
              }
              fields2 += "</div>";
              fields2 += "<br>";
            });

            $('#unitDataExpand').append(fields2);
          })
          .catch(error => {
              console.error('Error fetching unit data:', error);
               $('#unitData').empty(); // Clear loading message
               $('#unitData').append('<p>Error loading unit data.</p>');
          });

        // #3 Get sample data
        fetch(`https://postgrest-seamlessgeolmap-734948684426.us-central1.run.app/borehole_sample_table?boreid=eq.${id}`, {
          headers: headers
        })
          .then(response => {
              if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
              return response.json();
           })
          .then(results => {
            $('#samplingData').empty(); // Clear loading message
            $('#samplingDataExpand').empty();
            if (results.length === 0) {
                 $('#samplingData').append('<p>No sample data found.</p>');
                 return;
            }

            console.log(results);
            var fields = "";

            // Total number of samples
            fields += "<span class='field-heading'>Total Samples: </span> <span class='field-data'>" + results.length + " </span><br>";

            // Sample types
            var orgs = [...new Set(results.map(result => result.samplemethod).filter(Boolean))].join(", ") || "N/A";
            fields += "<span class='field-heading'>Sample Types: </span> <span class='field-data'>" + orgs + " </span><br>";


            // Max/min N values
            var nValues = results.map(result => Number(result.nvalue)).filter(n => !isNaN(n) && Number.isFinite(n));
            if (nValues.length > 0) {
                var max = Math.max(...nValues);
                var min = Math.min(...nValues);
                 fields += "<span class='field-heading'>N-Value Range: </span> <span class='field-data'>" + min + "-" + max + " blows/ft</span><br>";
            } else {
                 fields += "<span class='field-heading'>N-Value Range: </span> <span class='field-data'>No Data</span><br>";
            }


            // Check for grain size data
            var yesNo = results.some(result =>
              result.gravel_percent != null || result.sand_percent != null || result.fines_percent != null
            );
            yesNo = yesNo ? "Yes" : "No Data";
            fields += "<span class='field-heading'>Contains Grain Size %: </span> <span class='field-data'>" + yesNo + "</span><br>";

            // Check for moisture/density data
            yesNo = results.some(result =>
              result.labmoisture_percent != null || result.labdrydensity_pcf != null
            );
            yesNo = yesNo ? "Yes" : "No Data";
            fields += "<span class='field-heading'>Moisture or Density Results: </span> <span class='field-data'>" + yesNo + "</span><br>";

            // Check for Atterberg limits
            yesNo = results.some(result =>
              result.pl != null || result.ll != null
            );
            yesNo = yesNo ? "Yes" : "No Data";
            fields += "<span class='field-heading'>Contains Atterberg Limits: </span> <span class='field-data'>" + yesNo + "</span><br>";

            // Check for soil consolidation data - check for non-null values
             yesNo = results.some(result =>
              result.sct_dry_percent != null || result.sct != null
             );
             yesNo = yesNo ? "Yes" : "No Data";
             fields += "<span class='field-heading'>Soil Consolidation Data: </span> <span class='field-data'>" + yesNo + "</span><br>";

            // Check for shear data - check for non-null values
            yesNo = results.some(result =>
              result.shear_type != null || result.shearangle_degree != null || result.shearcohesion_psi != null
            );
            yesNo = yesNo ? "Yes" : "No Data";
            fields += "<span class='field-heading'>Contains Shear Data: </span> <span class='field-data'>" + yesNo + "</span><br>";

            // Check for chemical data - check for non-null values
            yesNo = results.some(result =>
              result.resistivity_ohm_cm != null || result.sulfates_ppm != null || result.chlorides_ppm != null || result.organics_percent_weight != null || result.ph != null
            );
            yesNo = yesNo ? "Yes" : "No Data";
            fields += "<span class='field-heading'>Contains Chemical Results: </span> <span class='field-data'>" + yesNo + "</span><br>";

            // Check for notes - check for non-null/non-empty strings
            yesNo = results.some(result => result.notes && result.notes.trim() !== "");
            yesNo = yesNo ? "Yes" : "No Data";
            fields += "<span class='field-heading'>Sample Notes: </span> <span class='field-data'>" + yesNo + "</span>";


            fields += "<br>";
            $('#samplingData').empty();
            $('#samplingData').append(fields);

            var fields3 = "<br>";
            results.forEach(att => {
              fields3 += "<div class='ibox'>";

              if (att.samplenumber != null) {
                fields3 += "<span class='field-heading-sm'>Sample Number: </span> <span class='field-data-sm'>" + check(att.samplenumber) + "</span> | ";
              }
              // Handle sample depth range
               const sampleLower = check(att.samplelower_depth);
               const sampleUpper = check(att.sampleupperdepth);
              if (sampleLower !== " " || sampleUpper !== " ") {
                  fields3 += "<span class='field-heading-sm'>Sample Depth Range: </span> <span class='field-data-sm'>" + sampleUpper + "-" + sampleLower + " ft</span> | "; // Note order swap based on UI text
              }
              if (att.samplemethod != null) {
                fields3 += "<span class='field-heading-sm'>Sample Method: </span> <span class='field-data-sm'>" + check(att.samplemethod) + "</span> | ";
              }
              if (att.nvalue != null) {
                fields3 += "<span class='field-heading-sm'>N Value: </span> <span class='field-data-sm'>" + check(att.nvalue) + "</span> | ";
              }
              if (att.gravel_percent != null) {
                fields3 += "<span class='field-heading-sm'>Gravel %: </span> <span class='field-data-sm'>" + check(att.gravel_percent) + "</span> | ";
              }
              if (att.sand_percent != null) {
                fields3 += "<span class='field-heading-sm'>Sand %: </span> <span class='field-data-sm'>" + check(att.sand_percent) + "</span> | ";
              }
              if (att.fines_percent != null) {
                fields3 += "<span class='field-heading-sm'>Fines %: </span> <span class='field-data-sm'>" + check(att.fines_percent) + "</span> | ";
              }
               // Use labmoisture_percent field
               if (att.labmoisture_percent != null) {
                 fields3 += "<span class='field-heading-sm'>Moisture %: </span> <span class='field-data-sm'>" + check(att.labmoisture_percent) + "</span> | ";
               }
               // Use labdrydensity_pcf field
               if (att.labdrydensity_pcf != null) {
                 fields3 += "<span class='field-heading-sm'>Dry Density (pcf): </span> <span class='field-data-sm'>" + check(att.labdrydensity_pcf) + "</span> | ";
               }
              if (att.ll != null) {
                fields3 += "<span class='field-heading-sm'>Liquid Limit: </span> <span class='field-data-sm'>" + check(att.ll) + "</span> | ";
              }
              if (att.pl != null) {
                fields3 += "<span class='field-heading-sm'>Plastic Limit: </span> <span class='field-data-sm'>" + check(att.pl) + "</span> | ";
              }
              if (att.pi != null) {
                fields3 += "<span class='field-heading-sm'>Plasticity Index: </span> <span class='field-data-sm'>" + check(att.pi) + "</span> | ";
              }
               // Use sct field
               if (att.sct != null) {
                 fields3 += "<span class='field-heading-sm'>Soil Consolidation %: </span> <span class='field-data-sm'>" + check(att.sct) + "</span> | ";
               }
               // Use sct_dry_percent field
               if (att.sct_dry_percent != null) {
                 fields3 += "<span class='field-heading-sm'>Dry Soil Consolidation %: </span> <span class='field-data-sm'>" + check(att.sct_dry_percent) + "</span> | ";
               }
              if (att.shear_type != null) {
                fields3 += "<span class='field-heading-sm'>Shear Type: </span> <span class='field-data-sm'>" + check(att.shear_type) + "</span> | ";
              }
              if (att.shearangle_degree != null) {
                fields3 += "<span class='field-heading-sm'>Shear Angle (degrees): </span> <span class='field-data-sm'>" + check(att.shearangle_degree) + "</span> | ";
              }
              if (att.shearcohesion_psi != null) {
                fields3 += "<span class='field-heading-sm'>Shear Cohesion (psi): </span> <span class='field-data-sm'>" + check(att.shearcohesion_psi) + "</span> | ";
              }
              if (att.resistivity_ohm_cm != null) {
                fields3 += "<span class='field-heading-sm'>Resistivity (ohm-cm): </span> <span class='field-data-sm'>" + check(att.resistivity_ohm_cm) + "</span> | ";
              }
              if (att.sulfates_ppm != null) {
                fields3 += "<span class='field-heading-sm'>Sulfates (ppm): </span> <span class='field-data-sm'>" + check(att.sulfates_ppm) + "</span> | ";
              }
              if (att.chlorides_ppm != null) {
                fields3 += "<span class='field-heading-sm'>Chlorides (ppm): </span> <span class='field-data-sm'>" + check(att.chlorides_ppm) + "</span> | ";
              }
              if (att.organics_percent_weight != null) {
                fields3 += "<span class='field-heading-sm'>Organics (weight %): </span> <span class='field-data-sm'>" + check(att.organics_percent_weight) + "</span> | ";
              }
              if (att.ph != null) {
                fields3 += "<span class='field-heading-sm'>pH: </span> <span class='field-data-sm'>" + check(att.ph) + "</span> | ";
              }
              if (att.notes != null && att.notes.trim() !== "") {
                fields3 += "<span class='field-heading-sm'>Sample Notes: </span> <span class='field-data-sm'>" + check(att.notes) + "</span> | ";
              }

               // Remove trailing " | " if present
              if (fields3.endsWith(" | </span>")) {
                  fields3 = fields3.slice(0, -10) + "</span>";
              }

              fields3 += "</div>";
              fields3 += "<br>";
            });

            $('#samplingDataExpand').append(fields3);
          })
          .catch(error => {
              console.error('Error fetching sample data:', error);
               $('#samplingData').empty(); // Clear loading message
               $('#samplingData').append('<p>Error loading sample data.</p>');
           });
      }

      // Helper function to check for null/undefined values
      function check(val) {
         // Return an empty string for null, undefined, or empty string, otherwise return the value
         return (val === null || val === undefined || val === "") ? " " : val;
      }


      // Token refresh handling when errors occur
       // Modify error handling to potentially use the passed token for refresh logic if needed
      mapView.on("layerview-create-error", function(event) { // Use layerview-create-error for TileLayer issues
          console.error("LayerView creation error:", event.error, "Layer:", event.layer.id);
           if (event.layer.id === "24k" && event.error) { // Check if it's our secured layer
              // Check for specific error types indicating token issues (codes vary by server/version)
              // Common ones include 401, 403, or specific ArcGIS Server error codes
              const errorDetails = event.error.details;
              const isAuthError = event.error.name === "identity-manager:not-authorized" ||
                                  (errorDetails && (errorDetails.httpStatus === 401 || errorDetails.httpStatus === 403));

              if (isAuthError) {
                  console.log("Token likely invalid or expired for 24k layer, attempting refresh...");
                  // Re-initiate the token fetch process
                  if (firebase && firebase.auth().currentUser) {
                      getArcGISToken(); // Re-call the function to get a new token and re-initialize
                      // Note: Re-calling getArcGISToken will trigger initializeMap again.
                      // Consider if you need to prevent multiple initializations,
                      // perhaps by clearing the map container or using flags.
                  } else {
                     console.log("No Firebase user, cannot refresh token automatically.");
                  }
              }
          }
      });


      // Zoom to the extent of all features when map is ready
      mapView.when(function() {
        // Remove loading indicator when map is ready
        removeLoadingIndicator();

        // Zoom to the data extent of the WFS layer
        layer
          .when(function() {
             console.log("WFS Layer loaded, querying extent...");
             return layer.queryExtent();
          })
          .then(function(response) {
             console.log("WFS Layer extent received:", response.extent);
             if (response.extent) {
                 mapView.goTo(response.extent.expand(1.5)); // Zoom out slightly from the exact extent
             } else {
                 console.warn("Could not get WFS layer extent.");
             }
          }).catch(err => {
             console.error("Error querying WFS layer extent:", err);
             // Keep default zoom if extent fails
          });

        // Set up Calcite popup and panel sync
        CalciteMapArcGISSupport.setPopupPanelSync(mapView);
      });

      // Watch for map extent changes and update feature count
      let stationaryWatchHandle = null; // To manage the watcher
      let queryAbortController = null; // To cancel pending queries

      mapView.watch("stationary", function(isStationary) {
          if (isStationary) {
              // Cancel any previous pending query
              if (queryAbortController) {
                  queryAbortController.abort();
              }
              queryAbortController = new AbortController(); // Create a new controller for this query

              const query = {
                  where: "1=1",
                  geometry: mapView.extent,
                  spatialRelationship: "intersects",
                  returnGeometry: false,
              };

              // Use signal for queryFeatures to allow cancellation
              layer.queryFeatureCount(query, { signal: queryAbortController.signal })
                  .then(function(count) {
                      queryAbortController = null; // Query completed
                      let displayCount = count;
                      if (count >= 1000) { // Assuming server limit or performance threshold
                          displayCount = "1000+"; // Indicate more than limit
                      }
                       document.getElementById('statsDiv').innerHTML = "Visible Points: " + displayCount;
                  })
                  .catch(function(error) {
                      queryAbortController = null; // Query failed or was aborted
                      if (error.name === 'AbortError') {
                         console.log("Feature count query aborted.");
                      } else {
                         console.error("Error getting feature count:", error);
                          document.getElementById('statsDiv').innerHTML = "Count Unavailable";
                      }
                  });
          } else {
              // Map is moving, cancel pending query if any
              if (queryAbortController) {
                  queryAbortController.abort();
                  queryAbortController = null;
              }
               document.getElementById('statsDiv').innerHTML = "Calculating..."; // Indicate loading
          }
      });


// Create search widget
var searchWidget = new Search({
    container: "searchWidgetDiv",
    view: mapView,
    includeDefaultSources: false,
    locationEnabled: true,
    minSuggestCharacters: 3,
    maxSuggestions: 6, // Adjusted as per previous suggestion
    searchAllEnabled: false,
    popupEnabled: true,
    sources: [{
        layer: new WFSLayer({ 
            url: "https://ugs-geoserver-prod-flbcoqv7oa-uc.a.run.app/geoserver/wfs",
            name: "borehole_locations", // WFS layer name
            namespaceUri: "hazards",   // WFS namespace
            outFields: ["*"], // Request fields needed for popup/suggestions
            // id: "search-wfs" // Optional: unique ID if needed
        }),

        searchFields: ["boreid", "project_name"], // Fields to search on
        suggestionTemplate: "{boreid} ({project_name})", // How suggestions appear
        displayField: "boreid", // Field shown prominently in results
        exactMatch: false,
        outFields: ["*"], // Fields to retrieve for the result/popup
        name: "Borehole ID/Project",
        placeholder: "e.g., D-M12 or Project Name",
        popupTemplate: popupTemplate, // Reuse your existing popup template
        zoomScale: 5000, // Zoom closer on result selection
        resultSymbol: {
            type: "simple-marker",
            style: "circle",
            color: [255, 255, 0, 0.8],
            size: "12px",
            outline: { color: [0, 0, 0, 0.8], width: 1 }
        },
    }]
});


      // Set up search expand events
      CalciteMapArcGISSupport.setSearchExpandEvents(searchWidget);

      // Add map widgets
      var home = new Home({ view: mapView });
      mapView.ui.add(home, "top-left");

      var zoom = new Zoom({ view: mapView });
      mapView.ui.add(zoom, "top-left");

      var compass = new Compass({ view: mapView });
      mapView.ui.add(compass, "top-left");

      var basemapToggle = new BasemapToggle({
        view: mapView,
        nextBasemap: "satellite" // Use nextBasemap instead of secondBasemap
      });
      mapView.ui.add(basemapToggle, "bottom-right");

      var scaleBar = new ScaleBar({
        view: mapView,
         unit: "dual" // Show both metric and imperial units
      });
      mapView.ui.add(scaleBar, "bottom-left");

      var attribution = new Attribution({ view: mapView });
      mapView.ui.add(attribution, "manual"); // Add manually to avoid overlap

      // Add legend widget - configure AFTER layers are potentially added
       var legendWidget = new Legend({
           container: "legendDiv",
           view: mapView,
           // Dynamically build layerInfos based on layers added to the map
           layerInfos: [
               {
                   layer: layer, // The WFS layer always added
                   title: "Exploration Method"
               }
               // Conditionally add the TileLayer if it was added
           ].concat(token && mapLayer ? [{ layer: mapLayer, title: mapLayer.title }] : [])
       });


      // Add layer list widget - configure AFTER layers are potentially added
       var layerListWidget = new LayerList({
           container: "layersDiv",
           view: mapView
           // Add listItemCreatedFunction if custom actions are needed
       });

        console.log("Map initialization complete.");
    }; // End of initializeMap definition

    // Check if map initialization function is ready before attempting to call it later
    console.log("ArcGIS API loaded, initializeMap function defined.");

}); // End of require block

// --- Modified getArcGISToken Function ---
function getArcGISToken() {
  try {
    const functions = firebase.functions();
    updateLoadingStatus('Loading map...', 'Requesting secure token...');
    const proxyGetArcGISTokenFn = functions.httpsCallable('proxyGetArcGISToken');

    proxyGetArcGISTokenFn()
      .then(function(result) {
        const token = result.data.token;
        console.log('ArcGIS token received via proxy:', token ? 'Success' : 'No token received');

        // NOW call initializeMap with the token
        if (typeof initializeMap === 'function') {
           initializeMap(token);
        } else {
           console.error("initializeMap function not ready when token received.");
           // Handle error - maybe retry or show error message
           updateLoadingStatus('Initialization Error', 'Map components failed to load.');
        }
      })
      .catch(function(error) {
        console.error('Error getting ArcGIS token via proxy:', error.code, error.message, error.details);
        updateLoadingStatus('Authentication Warning', `Could not get token: ${error.message}. Some features may be limited.`);

        // Initialize map WITHOUT the token
         if (typeof initializeMap === 'function') {
           initializeMap(null); // Pass null to indicate no token
        } else {
           console.error("initializeMap function not ready on token fetch failure.");
           updateLoadingStatus('Initialization Error', 'Map components failed to load.');
        }
      });
  } catch (error) {
    console.error('Error setting up token function call:', error);
    updateLoadingStatus('Service Error', 'Failed to connect to authentication service. Some features may be limited.');

    // Initialize map WITHOUT the token
    if (typeof initializeMap === 'function') {
       initializeMap(null); // Pass null to indicate no token
    } else {
        console.error("initializeMap function not ready on function call setup error.");
        updateLoadingStatus('Initialization Error', 'Map components failed to load.');
    }
  }
}

// --- Modified loadArcGISAPI Function ---
// This function is now effectively redundant as initialization is triggered
// directly from getArcGISToken after the token is received or fails.
// You can remove the call to loadArcGISAPI() from getArcGISToken.
function loadArcGISAPI() {
  console.log('loadArcGISAPI called - Map initialization now happens after token fetch.');
  // No longer responsible for triggering map init directly.
}

// --- Ensure Auth Flow Triggers Token Fetch Correctly ---
function initAuth() {
    const auth = firebase.auth();

    auth.onAuthStateChanged(function(user) {
        if (user) {
            console.log('User signed in:', user.uid);
            updateLoadingStatus('Loading map...', 'Authenticating map services...');
            getArcGISToken(); // This will now fetch token AND initialize the map
        } else {
            console.log('No user signed in, signing in anonymously...');
            auth.signInAnonymously()
                .then(() => {
                     console.log("Anonymous sign-in successful.");
                     // onAuthStateChanged will fire again with the anonymous user,
                     // triggering getArcGISToken automatically. No need to call it here.
                })
                .catch(function(error) {
                    console.error('Anonymous sign-in error:', error);
                    updateLoadingStatus('Authentication Error', 'Failed to sign in anonymously. Some features may be limited.');
                    // Initialize map WITHOUT token since auth failed
                    if (typeof initializeMap === 'function') {
                        initializeMap(null);
                    } else {
                         console.error("initializeMap function not ready on anonymous sign-in failure.");
                         updateLoadingStatus('Initialization Error', 'Map components failed to load.');
                    }
                });
        }
    });
}
  </script>
</body>
</html>