<!DOCTYPE html>
<html>
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PPGF6Z2N');</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="description" content="Subsurface Geotechnical Database - Utah Geological Survey">

  <title>Subsurface Geotechnical Database</title>

  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-bootstrap.min-v0.10.css">

  <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.10.css">

  <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/css/main.css">

  <link rel="stylesheet" href="/apps/_ugsmaptemplate/template.css">

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    h2 {
      font-size: 20px;
    }

    .ibox{
      outline: 1px solid #e2e8f3;
      padding: 4px;
      margin-bottom: 5px; /* Added spacing */
    }

    .calcite-title:before {
      content: url('https://geology.utah.gov/apps/_ugsmaptemplate/logo_main.png');
      padding: 6px 12px 0 2px;
      cursor: pointer;
    }

    .esri-feature__content-element {
      padding: 0 0 0 0;
    }

    .esri-popup__inline-actions-container>.esri-popup__action,
    .esri-popup__inline-actions-container>.esri-popup__action-toggle {
      margin: 0 7px;
      max-width: 100%;
    }

    .esri-popup__inline-actions-container:only-child>.esri-popup__action,
    .esri-popup__inline-actions-container:only-child>.esri-popup__action-toggle {
      max-width: 100%;
    }

    .esri-layer-list__item-actions-menu-item--active,
    .esri-layer-list__item-actions-menu-item--active:hover {
      background-color: #ffffff;
    }

    .field-heading {
      font: 600 12px Georgia, serif;
    }

    .field-data {
      font: 12px Georgia, serif;
    }

    .field-heading-sm {
      font: 600 11px Georgia, serif;
    }

    .field-data-sm {
      font: 11px Georgia, serif;
    }

    .esri-legend__layer-caption {
      display: none;
    }

    #statsDiv {
      position: absolute;
      bottom: 30px;
      left: 20px;
      color: black;
      font-size: 14px;
      font-weight: 700;
      background-color: rgba(255, 255, 255, 0.7); /* Added for visibility */
      padding: 5px;                         /* Added for visibility */
      border-radius: 4px;                   /* Added for visibility */
    }

    .bold{
      font-weight: 600;
    }

    .page-loading {
        position: fixed; /* Changed to fixed */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex; /* Use flex by default */
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        font-size: 1.2em;
    }
    .page-loading img {
        margin-top: 10px;
        width: 50px;
        height: 50px;
    }

    /* Ensure panels are scrollable */
    .panel-body {
      max-height: calc(100vh - 120px); /* Adjust based on navbar/header height */
      overflow-y: auto;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>

  <script type="text/javascript">
    // Dojo configuration MUST come before loading the ArcGIS API
    var dojoConfig = {
      packages: [{
        name: "bootstrap",
        location: "https://esri.github.io/calcite-maps/dist/vendor/dojo-bootstrap"
      },
      {
        name: "calcite-maps",
        location: "https://esri.github.io/calcite-maps/dist/js/dojo"
      }]
    };
  </script>

  <script src="https://js.arcgis.com/4.24/"></script>

  <script type="text/javascript">
    // --- Global Variables ---
    let arcgisToken = null; // Holds the fetched token
    let mapLayer = null; // Reference to the secured TileLayer
    let map = null; // Reference to the ArcGIS Map object
    let mapView = null; // Reference to the ArcGIS MapView object
    let layer = null; // Reference to the WFS Layer
    let fullscreen = null; // Reference to Fullscreen widget
    let GlobalID = ""; // Holds BoreID for related data queries
    const projectName = 'https://us-central1-ut-dnr-ugs-geolmapportal-prod.cloudfunctions.net'; // Not used here, but kept if needed elsewhere

    // --- Loading Indicator Functions ---
    function showLoading(message) {
      // Create loading div if it doesn't exist yet
      let loadingDiv = document.querySelector('.page-loading');
      if (!loadingDiv) {
        loadingDiv = document.createElement('div');
        loadingDiv.className = 'page-loading';
        document.body.appendChild(loadingDiv);
      }
      
      // Update the loading message
      loadingDiv.innerHTML = `
        <div>
          <h3>Loading</h3>
          <p>${message || 'Please wait...'}</p>
          <img src="https://geology.utah.gov/apps/_ugsmaptemplate/loading.gif" alt="Loading">
        </div>
      `;
      
      // Make sure it's visible
      loadingDiv.style.display = 'flex';
      loadingDiv.style.opacity = '1';
    }

    function hideLoading() {
      const loadingDiv = document.querySelector('.page-loading');
      if (loadingDiv) {
        // Use fade out for smoother transition
        loadingDiv.style.transition = 'opacity 0.5s ease-out';
        loadingDiv.style.opacity = '0';
        setTimeout(() => {
          loadingDiv.style.display = 'none';
        }, 500);
      }
    }

    // --- Firebase Initialization and Auth Flow ---
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Starting Firebase initialization');
      showLoading('Initializing services...'); // Show loading indicator

      const firebaseConfig = {
        apiKey: "AIzaSyAi0ecBg7dfitM9Num5n7onxZATDSPaC_o", // Ensure this key is safe to expose or restrict its usage
        authDomain: "ut-dnr-ugs-borehole-prod.firebaseapp.com",
        projectId: "ut-dnr-ugs-borehole-prod",
        storageBucket: "ut-dnr-ugs-borehole-prod.appspot.com",
        messagingSenderId: "78333091254",
        appId: "1:78333091254:web:993c44895c1ea385dc3517",
        measurementId: "G-QP1XVRTH4Q"
      };

      try {
        if (!firebase.apps.length) { // Prevent re-initialization
             firebase.initializeApp(firebaseConfig);
        }
        firebase.analytics(); // Initialize Analytics
        console.log("Firebase initialized successfully");
        initAuth(); // Start authentication flow
      } catch (error) {
        console.error("Firebase initialization error:", error);
        updateLoadingStatus('Authentication Error', 'Failed to initialize Firebase. Some features may be limited.');
        window.initialArcGISToken = null;
        loadArcGISMap(); // Try to load map even if Firebase fails
      }
    });

    function initAuth() {
      const auth = firebase.auth();
      auth.onAuthStateChanged(function(user) {
        if (user) {
          console.log('User signed in:', user.uid);
          updateLoadingStatus('Authenticating map services...');
          getArcGISToken(); // Fetch token now that user is signed in
        } else {
          console.log('No user signed in, attempting anonymous sign-in...');
          updateLoadingStatus('Signing in...');
          auth.signInAnonymously()
            .catch(function(error) {
              console.error('Anonymous sign-in error:', error);
              updateLoadingStatus('Authentication Error', 'Failed to sign in. Some features may be limited.');
              window.initialArcGISToken = null;
              loadArcGISMap(); // Try to load map even if auth fails
            });
        }
      });
    }

    function getArcGISToken(refresh) {
      return new Promise((resolve, reject) => {
        try {
          const functions = firebase.functions(); // Current project's functions
          updateLoadingStatus(refresh ? 'Refreshing token...' : 'Requesting secure token...');
          const proxyGetArcGISTokenFn = functions.httpsCallable('proxyGetArcGISToken'); // Reference the PROXY function

          proxyGetArcGISTokenFn()
            .then(function(result) {
              const token = result.data.token; // Store token
              console.log('ArcGIS token received via proxy:', token ? 'Token received successfully' : 'No token received');
              
              // Store token globally
              window.initialArcGISToken = token;
              arcgisToken = token;
              
              if (!refresh) {
                updateLoadingStatus('Initializing map components...');
                loadArcGISMap(); // Trigger ArcGIS map initialization
              }
              
              resolve(token);
            })
            .catch(function(error) {
              console.error('Error getting ArcGIS token via proxy:', error.code, error.message, error.details);
              updateLoadingStatus('Authentication Warning', `Could not get token: ${error.message}. Some features may be limited.`);
              window.initialArcGISToken = null;
              arcgisToken = null;
              
              if (!refresh) {
                loadArcGISMap(); // Trigger map initialization even on error
              }
              
              reject(error);
            });
        } catch (error) {
          console.error('Error setting up token function call:', error);
          updateLoadingStatus('Service Error', 'Failed to connect to authentication service. Some features may be limited.');
          window.initialArcGISToken = null;
          arcgisToken = null;
          
          if (!refresh) {
            loadArcGISMap(); // Trigger map initialization on setup error
          }
          
          reject(error);
        }
      });
    }

    // --- ArcGIS Map Initialization ---
    // This function is called ONLY after the token fetch attempt is complete
    function loadArcGISMap() {
      console.log('loadArcGISMap called. Token available:', window.initialArcGISToken ? 'Yes' : 'No');

      require([
        // ArcGIS Core Modules
        "esri/WebMap",
        "esri/views/MapView",
        "esri/config",
        "esri/identity/IdentityManager",
        "esri/layers/TileLayer",
        "esri/layers/WFSLayer",
        "esri/layers/FeatureLayer", // Keep if used by search or other widgets
        "esri/symbols/SimpleMarkerSymbol", // Keep for WFS renderer
        "esri/core/watchUtils",
        // Widgets
        "esri/widgets/Home",
        "esri/widgets/Zoom",
        "esri/widgets/Compass",
        "esri/widgets/Search",
        "esri/widgets/Legend",
        "esri/widgets/LayerList",
        "esri/widgets/BasemapToggle",
        "esri/widgets/Fullscreen",
        "esri/widgets/ScaleBar",
        "esri/widgets/Attribution",
        // Dojo/Bootstrap/Calcite (Loaded via dojoConfig but listed for clarity)
        "dgrid/Grid", // Keep if used by queryRelated (though example doesn't show grid)
        "dojo/query",
        "dojo/_base/array",
        "bootstrap/Collapse",
        "bootstrap/Dropdown",
        "calcite-maps/calcitemaps-v0.10",
        "calcite-maps/calcitemaps-arcgis-support-v0.10",
        "dojo/domReady!" // Ensures DOM is ready
      ], function(
         WebMap, MapView, esriConfig, IdentityManager, TileLayer, WFSLayer, FeatureLayer, SimpleMarkerSymbol, watchUtils,
         Home, Zoom, Compass, Search, Legend, LayerList, BasemapToggle, Fullscreen, ScaleBar, Attribution,
         Grid, query, arrayUtils, Collapse, Dropdown, CalciteMaps, CalciteMapArcGISSupport
      ) {
          console.log('ArcGIS Modules Loaded. Initializing Map...');
          const token = window.initialArcGISToken; // Get token potentially set by async call
          console.log('ArcGIS initialization with token:', token ? 'Available' : 'Not available');

          // --- Create Map and View First ---
          map = new WebMap({ basemap: "topo" });
          mapView = new MapView({
            container: "mapViewDiv",
            map: map,
            padding: { top: 50, bottom: 0 },
            center: [-111.3, 39.4],
            zoom: 7,
            scale: 4600000,
            ui: {components: []}, // Remove default widgets
            popup: {
                dockEnabled: true,
                dockOptions: { buttonEnabled: false } // Disable undocking
            }
          });

// --- Register Token with IdentityManager ---
if (token) {
    try {
        // Register the token for the server domain
        IdentityManager.registerToken({
            server: "https://webmaps.geology.utah.gov/arcgis",
            token: token
        });
        
        // Also set up the server info properly
        IdentityManager.registerServer({
            server: "https://webmaps.geology.utah.gov/arcgis",
            tokenServiceUrl: "https://webmaps.geology.utah.gov/arcgis/tokens/"
        });
        
        console.log("Token registered with IdentityManager for secure services");
    } catch (error) {
        console.error("Error registering token:", error);
    }
}

// --- Create Secured TileLayer ---
if (token) {
    // Create the TileLayer with token directly in the URL as a parameter
    const tokenParam = `?token=${token}`;
    mapLayer = new TileLayer({
        url: "https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer" + tokenParam,
        id: "24k",
        opacity: 0.7,
        title: "1:24,000 Geologic Maps",
        visible: false,
        // Add fallback mechanism for individual tile requests
        tileServers: [`https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer/tile/{level}/{row}/{col}${tokenParam}`]
    });
    
    // Register token with IdentityManager (just this part, remove registerServer)
    try {
        IdentityManager.registerToken({
            server: "https://webmaps.geology.utah.gov/arcgis",
            token: token
        });
        console.log("Token registered with IdentityManager for secure services");
    } catch (error) {
        console.error("Error registering token:", error);
    }
    
    // Add the layer to the map
    map.add(mapLayer);
    console.log('24k layer added to map.');
    
    // Add error handling for TileLayer loading
    mapLayer.when(
        () => { console.log('24k Layer finished loading!'); },
        (error) => { 
            console.error('24k Layer failed to load:', error); 
            console.log('Error details:', error.details);
            console.log('Token used:', token ? 'Token available' : 'No token');
            
            // Try fallback approach if loading fails
            console.log("Attempting fallback approach for secure layer...");
            const fallbackLayer = new TileLayer({
                url: `https://webmaps.geology.utah.gov/arcgis/rest/services/GeolMap/7_5_Quads/MapServer`,
                id: "24k-fallback",
                opacity: 0.7,
                title: "1:24,000 Geologic Maps (Fallback)",
                visible: false,
                requestOptions: {
                    query: {
                        token: token
                    }
                }
            });
            map.add(fallbackLayer);
        }
    );
}
          // Initialize fullscreen widget
          fullscreen = new Fullscreen({ view: mapView });

          // --- Create WFS Layer (Boreholes - Public) ---
          const wfsRenderer = {
            type: "unique-value",
            field: "exploration_method",
            uniqueValueInfos: [
              {value:"Drill", label:"Drill", symbol:{type:"simple-marker", color: [255, 0, 0], style: "circle", outline: {width: 0}, size: 6}},
              {value:"Excavation", label:"Trench", symbol:{type:"simple-marker", color: [0, 0, 255], style: "circle", outline: {width: 0}, size: 6}},
              {value:"CPT", label:"Cone Penetration Test", symbol:{type:"simple-marker", color: [128, 0, 128], style: "circle", outline: {width: 0}, size: 6}}
            ]
          };
          layer = new WFSLayer({ // Assign to global 'layer'
            url: "https://ugs-geoserver-prod-flbcoqv7oa-uc.a.run.app/geoserver/wfs",
            name: "borehole_locations", // WFS Layer Name
            namespaceUri: "hazards", // WFS Namespace
            id: "locations",
            outFields: ["*"],
            opacity: 0.8,
            title: "Geotechnical Explorations",
            renderer: wfsRenderer,
            popupTemplate: { // Define popup template directly here
                 outFields: ["*"],
                 actions: [{ title: "Get Geotechnical Data", id: "sample-data", className: "esri-icon-table" }],
                 content: createPopup // Use the globally defined function
            }
          });
          map.add(layer); // Add WFS layer to the map

          // --- Setup Popups and Actions ---
          watchUtils.when(mapView.popup, "selectedFeature", function(feature) {
              // Added checks for feature and attributes
              if (feature && feature.attributes && feature.attributes.boreid) {
                 GlobalID = feature.attributes.boreid;
                 console.log("Selected BoreID:", GlobalID);
              } else {
                 GlobalID = ""; // Reset if feature is deselected or lacks boreid
              }
          });

          mapView.popup.on("trigger-action", function(event) {
              if (event.action.id === "sample-data") {
                console.log("Popup action 'sample-data' triggered.");
                if (GlobalID) { // Check if GlobalID is set
                    console.log("Querying related data for BoreID:", GlobalID);
                    queryRelated(GlobalID); // Call the globally defined function
                } else {
                    console.warn("No BoreID selected (GlobalID is empty). Cannot query related data.");
                    // Optionally clear the data panels or show a message
                    $('#projectDetails, #unitData, #unitDataExpand, #samplingData, #samplingDataExpand').empty().html("<i>Select a point first.</i>");
                    showHideCalcitePanels("#panelData", "#collapseData");
                }
              }
          });

          // --- Add Widgets ---
          var home = new Home({ view: mapView }); mapView.ui.add(home, "top-left");
          var zoom = new Zoom({ view: mapView }); mapView.ui.add(zoom, "top-left");
          var compass = new Compass({ view: mapView }); mapView.ui.add(compass, "top-left");
          var basemapToggle = new BasemapToggle({ view: mapView, secondBasemap: "satellite" }); mapView.ui.add(basemapToggle, "bottom-right");
          var scaleBar = new ScaleBar({ view: mapView }); mapView.ui.add(scaleBar, "bottom-left");
          var attribution = new Attribution({ view: mapView, visible: false }); mapView.ui.add(attribution, "manual"); // Initially hidden if desired

          // Search Widget (Ensure 'layer' is defined before this)
          var searchWidget = new Search({
            container: "searchWidgetDiv",
            view: mapView,
            includeDefaultSources: false,
            locationEnabled: true, // Allow searching near current location
            sources: [{
              layer: layer, // Search the WFS layer
              searchFields: ["boreid", "project_name", "projectid"],
              displayField: "boreid",
              exactMatch: false,
              name: "Borehole ID / Project Name",
              placeholder: "e.g., D-M12-17-1985",
              outFields: ["*"],
              popupTemplate: layer.popupTemplate, // Use the same template
              autoNavigate: true, // Zoom to result
              zoomScale: 5000 // Zoom closer
            }]
          });
          CalciteMapArcGISSupport.setSearchExpandEvents(searchWidget);

          // Legend Widget (Ensure 'layer' is defined)
          var legendWidget = new Legend({
            container: "legendDiv",
            view: mapView,
            layerInfos: [{
                layer: layer, // Legend for WFS layer
                title: "Exploration Method"
              }
            ]
          });

          // LayerList Widget (Ensure 'map' is defined)
          var layerListWidget = new LayerList({
            container: "layersDiv",
            view: mapView
            // LayerList will automatically show layers currently in map.layers
          });

          // --- Token Refresh Logic ---
          mapView.on("error", function(error) {
             console.error("MapView error:", error);
             
             // Check if it's an authentication error
             if ((error.name === "identity-manager:not-authorized" || 
                  error.name === "identity-manager:user-aborted" ||
                  error.name === "request:server") &&
                  firebase && firebase.auth().currentUser) {
                  
                console.log("Authentication error detected, refreshing token...");
                getArcGISToken(true).then(function(newToken) {
                  // Try to register the new token
                  try {
                    IdentityManager.registerToken({
                      server: "https://webmaps.geology.utah.gov/arcgis",
                      token: newToken
                    });
                    console.log("New token registered with IdentityManager");
                    
                    // Refresh the layer if it exists
                    if (mapLayer) {
                      mapLayer.refresh();
                    }
                  } catch (e) {
                    console.error("Error registering refreshed token:", e);
                  }
                }).catch(function(error) {
                  console.error("Failed to refresh token:", error);
                });
             }
          });

          // --- Final Map Setup ---
          mapView.when(function() {
            removeLoadingIndicator(); // Remove loading indicator LAST
            // Initial extent query (ensure 'layer' is ready)
            layer.when(() => layer.queryExtent())
                 .then((response) => mapView.goTo(response.extent))
                 .catch((err) => console.error("Error querying initial extent:", err));
            // Sync panels AFTER map is ready
            CalciteMapArcGISSupport.setPopupPanelSync(mapView);
            console.log("Map and View are ready.");
          }).catch((err) => {
              console.error("MapView failed to initialize:", err);
              updateLoadingStatus("Map Error", "Failed to initialize the map view.");
          });

          // Feature count logic (ensure 'layer' is ready)
          watchUtils.whenTrue(mapView, "stationary", () => {
              if (!layer.loaded) return; // Don't query if layer isn't loaded
              const queryParams = layer.createQuery(); // Use createQuery
              queryParams.geometry = mapView.extent;
              queryParams.spatialRelationship = "intersects";
              layer.queryFeatureCount(queryParams) // Use queryFeatureCount if available and reliable for WFS, otherwise use queryFeatures().then(res => res.features.length)
                .then(function(count) {
                  let displayCount = count >= 1000 ? "1000+" : count;
                  document.getElementById('statsDiv').innerHTML = "Visible Features: " + displayCount;
                })
                .catch(function(error) {
                  console.error("Error getting feature count:", error);
                  document.getElementById('statsDiv').innerHTML = "Count Unavailable";
                });
          });

      }); // End require function
    } // End loadArcGISMap function

    // --- Helper Functions (Ensure these are defined) ---
    function updateLoadingStatus(title, message) {
      const loadingDiv = document.querySelector('.page-loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = `<div><h3>${title}</h3><p><small>${message}</small></p></div>`;
      }
    }

    function removeLoadingIndicator() {
      const loadingDiv = document.querySelector('.page-loading');
      if (loadingDiv) {
        // Use fade out for smoother transition
        loadingDiv.style.transition = 'opacity 0.5s ease-out';
        loadingDiv.style.opacity = '0';
        setTimeout(() => { loadingDiv.remove(); }, 500); // Remove after fade
      }
    }

    // Function to show/hide Calcite panels (Ensure query is available or use jQuery)
    function showHideCalcitePanels(showPanel, showCollapse) {
        // Check if jQuery is loaded, otherwise use querySelector
        if (typeof $ !== 'undefined') {
            $(".panel.in").removeClass("in");
            $(".panel-collapse.in").removeClass("in");
            if (showPanel) {
                $(showPanel).collapse("show");
                $(showCollapse).collapse("show");
            }
        } else {
             console.warn("jQuery not loaded for showHideCalcitePanels");
             // Basic JS equivalent (might not handle Bootstrap collapse correctly)
             document.querySelectorAll(".panel.in").forEach(el => el.classList.remove("in"));
             document.querySelectorAll(".panel-collapse.in").forEach(el => el.classList.remove("in"));
             // Showing requires more complex logic without Bootstrap JS/jQuery
        }
    }

    // Function to create popup content (Ensure check is defined)
    function createPopup(featureSet) {
        var content = "";
        showHideCalcitePanels("#panelData", "#collapseData"); // Show Data panel
        var att = featureSet.graphic.attributes;
        if(att.project_name) content += "<span class='bold'>Project Name: </span>" + check(att.project_name) + "<br/>";
        if(att.consultant) content += "<span class='bold'>Consultant: </span>" + check(att.consultant) + "<br/>";
        if(att.date_completed) {
            let date = new Date(att.date_completed);
            content += "<span class='bold'>Date Completed: </span>" + (!isNaN(date) ? date.toDateString() : check(att.date_completed)) + "<br/>";
        }
        if(att.exploration_method) content += "<span class='bold'>Exploration Method: </span>" + check(att.exploration_method) + "<br />";
        if(att.gw_depth !== null) content += "<span class='bold'>Groundwater Depth (ft):</span>" + check(att.gw_depth) + "<br />"; // Check for null explicitly
        if(att.bedrock_refusal !== null) content += "<span class='bold'>Refusal Depth (ft): </span>" + check(att.bedrock_refusal) + "<br />";
        if(att.completion) content += "<span class='bold'>Completion: </span>" + check(att.completion) + "<br />";
        if(att.latitude && att.longitude) content += "<span class='bold'>Location: </span>" + att.latitude.toFixed(5) + ", " + att.longitude.toFixed(5) + "<br />";
        if(att.elevation_ft !== null) content += "<span class='bold'>Elevation (ft): </span>" + check(att.elevation_ft) + "<br />";
        if(att.geologic_unit) content += "<span class='bold'>Geologic Unit: </span>" + check(att.geologic_unit) + "<br />";
        if(att.databasedate) {
            let date2 = new Date(att.databasedate);
            content += "<span class='bold'>Added to DB: </span>" + (!isNaN(date2) ? date2.toDateString() : check(att.databasedate)) + "<br />";
        }
        if(att.report_url) content += "<span class='bold'>Report URL: </span> <a target='_blank' href='" + check(att.report_url) + "'>External Link</a><br />";
        return content;
    }

    // Function to fetch related data (Ensure check and $ are defined or replaced)
    function queryRelated(id) {
         // ... (Implementation as provided before, ensure jQuery ($) usage is intended or replace) ...
         console.log("Fetching related data for:", id);
         showLoading("Fetching related data...");
         // ... (rest of fetch logic using $ or document.getElementById) ...
         // Make sure to call hideLoading() in a .finally() block if using Promises extensively
         const headers = { 'Accept-Profile': 'boreholes' };
         const baseUrl = "https://postgrest-seamlessgeolmap-734948684426.us-central1.run.app";

         // Clear panels
         $('#projectDetails, #unitData, #unitDataExpand, #samplingData, #samplingDataExpand').empty().html("<i>Loading...</i>");

         Promise.allSettled([
             fetch(`${baseUrl}/borehole_locations?boreid=eq.${id}`, { headers }).then(res => res.ok ? res.json() : Promise.reject(res)),
             fetch(`${baseUrl}/borehole_unit_table?boreid=eq.${id}`, { headers }).then(res => res.ok ? res.json() : Promise.reject(res)),
             fetch(`${baseUrl}/borehole_sample_table?boreid=eq.${id}`, { headers }).then(res => res.ok ? res.json() : Promise.reject(res))
         ]).then(results => {
             // Project Details
             if (results[0].status === 'fulfilled' && results[0].value.length > 0) {
                 const att = results[0].value[0]; let fields = "";
                 if (att.projectid) fields += "<span class='field-heading'>Project ID: </span><span class='field-data'>" + check(att.projectid) + "</span><br>";
                 if (att.udot_pin) fields += "<span class='field-heading'>UDOT Pin: </span><span class='field-data'>" + check(att.udot_pin) + "</span><br>";
                 if (att.exploration_type) fields += "<span class='field-heading'>Type: </span><span class='field-data'>" + check(att.exploration_type) + "</span><br>";
                 if (att.exploration_equiptment) fields += "<span class='field-heading'>Equipment: </span><span class='field-data'>" + check(att.exploration_equiptment) + "</span><br>";
                 if (att.hammer_type) fields += "<span class='field-heading'>Hammer: </span><span class='field-data'>" + check(att.hammer_type) + "</span><br>";
                 if (att.coordinate_source) fields += "<span class='field-heading'>Coord Src: </span><span class='field-data'>" + check(att.coordinate_source) + "</span><br>";
                 if (att.elevation_source) fields += "<span class='field-heading'>Elev Src: </span><span class='field-data'>" + check(att.elevation_source) + "</span><br>";
                 if (att.enteredby) fields += "<span class='field-heading'>Entered By: </span><span class='field-data'>" + check(att.enteredby) + "</span><br>";
                 if (att.ugs_gdid) fields += "<span class='field-heading'>UGS GID: </span><span class='field-data'>" + check(att.ugs_gdid) + "</span><br>";
                 if (att.boreid) fields += "<span class='field-heading'>BoreID: </span><span class='field-data'>" + check(att.boreid) + "</span><br>";
                 if (att.notes) fields += "<span class='field-heading'>Notes: </span><span class='field-data'>" + check(att.notes) + "</span><br>";
                 $('#projectDetails').empty().append(fields || "<i>No details found.</i>");
             } else { $('#projectDetails').empty().html("<i>Error or no details found.</i>"); console.error("Proj Details Fetch Error:", results[0].reason); }

             // Unit Data
             if (results[1].status === 'fulfilled' && results[1].value.length > 0) {
                 const unitResults = results[1].value; let fields = ""; let fields2 = "";
                 fields += "<span class='field-heading'>Total Units: </span> <span class='field-data'>" + unitResults.length + " </span><br>";
                 const uscsOrgs = [...new Set(unitResults.map(r => r.uscs).filter(Boolean))];
                 fields += "<span class='field-heading'>USCS: </span> <span class='field-data'>" + (uscsOrgs.length > 0 ? uscsOrgs.join(", ") : "N/A") + " </span><br>";
                 const maxDepthArray = unitResults.map(r => Number(r.lowerdepth)).filter(n => !isNaN(n));
                 const maxdp = maxDepthArray.length > 0 ? Math.max(...maxDepthArray) : "N/A";
                 fields += "<span class='field-heading'>Max Depth: </span> <span class='field-data'>" + (maxdp !== "N/A" ? maxdp + " ft" : "N/A") + "</span><br>";
                 $('#unitData').empty().append(fields);

                 unitResults.forEach(att => {
                   let unitDetail = "<div class='ibox'>";
                   if(att.upperdepth !== null && att.lowerdepth !== null) unitDetail += "<span class='field-heading-sm'>Depth Range: </span><span class='field-data-sm'>" + check(att.upperdepth) + " - " + check(att.lowerdepth) + " ft</span><br>";
                   if(att.thickness !== null) unitDetail += "<span class='field-heading-sm'>Thickness: </span><span class='field-data-sm'>" + check(att.thickness) + " ft</span><br>";
                   if(att.uscs) unitDetail += "<span class='field-heading-sm'>USCS: </span><span class='field-data-sm'>" + check(att.uscs) + "</span><br>";
                   if(att.color) unitDetail += "<span class='field-heading-sm'>Color: </span><span class='field-data-sm'>" + check(att.color) + "</span><br>";
                   if(att.moisture_content) unitDetail += "<span class='field-heading-sm'>Moisture: </span><span class='field-data-sm'>" + check(att.moisture_content) + "</span><br>";
                   if(att.consistency) unitDetail += "<span class='field-heading-sm'>Consistency: </span><span class='field-data-sm'>" + check(att.consistency) + "</span><br>";
                   if(att.layer_description) unitDetail += "<span class='field-heading-sm'>Description: </span><span class='field-data-sm'>" + check(att.layer_description) + "</span><br>";
                   unitDetail += "</div>";
                   fields2 += unitDetail;
                 });
                 
                 $('#unitDataExpand').empty().append(fields2 || "<i>No detailed unit data.</i>");
             } else { $('#unitData, #unitDataExpand').empty().html("<i>Error or no unit data found.</i>"); console.error("Unit Data Fetch Error:", results[1].reason); }

             // Sampling Data
             if (results[2].status === 'fulfilled' && results[2].value.length > 0) {
                 const sampleResults = results[2].value; let fields = ""; let fields3 = "";
                 fields += "<span class='field-heading'>Total Samples: </span> <span class='field-data'>" + sampleResults.length + " </span><br>";
                 const sampleTypes = [...new Set(sampleResults.map(r => r.samplemethod).filter(Boolean))];
                 fields += "<span class='field-heading'>Types: </span> <span class='field-data'>" + (sampleTypes.length > 0 ? sampleTypes.join(", ") : "N/A") + " </span><br>";
                 const nValues = sampleResults.map(r => Number(r.nvalue)).filter(n => !isNaN(n));
                 if (nValues.length > 0) { const minN = Math.min(...nValues); const maxN = Math.max(...nValues); fields += "<span class='field-heading'>N-Range: </span> <span class='field-data'>" + minN + "-" + maxN + "</span><br>"; }
                 const checkExists = (arr, keys) => arr.some(item => keys.some(key => item[key]));
                 fields += "<span class='field-heading'>Grain Size?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['gravel_percent', 'sand_percent', 'fines_percent']) ? "Yes" : "No") + "</span><br>";
                 fields += "<span class='field-heading'>Moisture/Density?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['labmoisture_percent', 'labdrydensity_pcf']) ? "Yes" : "No") + "</span><br>";
                 fields += "<span class='field-heading'>Atterberg?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['pl', 'll', 'pi']) ? "Yes" : "No") + "</span><br>";
                 fields += "<span class='field-heading'>Consolidation?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['sct_dry_percent', 'sct']) ? "Yes" : "No") + "</span><br>";
                 fields += "<span class='field-heading'>Shear?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['shear_type', 'shearangle_degree', 'shearcohesion_psi']) ? "Yes" : "No") + "</span><br>";
                 fields += "<span class='field-heading'>Chemical?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['resistivity_ohm_cm', 'sulfates_ppm', 'chlorides_ppm', 'organics_percent_weight', 'ph']) ? "Yes" : "No") + "</span><br>";
                 fields += "<span class='field-heading'>Notes?: </span> <span class='field-data'>" + (checkExists(sampleResults, ['notes']) ? "Yes" : "No") + "</span>";
                 $('#samplingData').empty().append(fields);

                 sampleResults.forEach(att => {
                   let sampleDetail = "<div class='ibox'>";
                   if(att.sample_id) sampleDetail += "<span class='field-heading-sm'>Sample ID: </span><span class='field-data-sm'>" + check(att.sample_id) + "</span><br>";
                   if(att.depth !== null) sampleDetail += "<span class='field-heading-sm'>Depth: </span><span class='field-data-sm'>" + check(att.depth) + " ft</span><br>";
                   if(att.samplemethod) sampleDetail += "<span class='field-heading-sm'>Method: </span><span class='field-data-sm'>" + check(att.samplemethod) + "</span><br>";
                   if(att.nvalue) sampleDetail += "<span class='field-heading-sm'>N-Value: </span><span class='field-data-sm'>" + check(att.nvalue) + "</span><br>";
                   if(att.gravel_percent !== null) sampleDetail += "<span class='field-heading-sm'>Gravel %: </span><span class='field-data-sm'>" + check(att.gravel_percent) + "</span><br>";
                   if(att.sand_percent !== null) sampleDetail += "<span class='field-heading-sm'>Sand %: </span><span class='field-data-sm'>" + check(att.sand_percent) + "</span><br>";
                   if(att.fines_percent !== null) sampleDetail += "<span class='field-heading-sm'>Fines %: </span><span class='field-data-sm'>" + check(att.fines_percent) + "</span><br>";
                   if(att.labmoisture_percent !== null) sampleDetail += "<span class='field-heading-sm'>Lab Moisture %: </span><span class='field-data-sm'>" + check(att.labmoisture_percent) + "</span><br>";
                   if(att.labdrydensity_pcf !== null) sampleDetail += "<span class='field-heading-sm'>Lab Dry Density: </span><span class='field-data-sm'>" + check(att.labdrydensity_pcf) + " pcf</span><br>";
                   if(att.ll !== null) sampleDetail += "<span class='field-heading-sm'>Liquid Limit: </span><span class='field-data-sm'>" + check(att.ll) + "</span><br>";
                   if(att.pl !== null) sampleDetail += "<span class='field-heading-sm'>Plastic Limit: </span><span class='field-data-sm'>" + check(att.pl) + "</span><br>";
                   if(att.pi !== null) sampleDetail += "<span class='field-heading-sm'>PI: </span><span class='field-data-sm'>" + check(att.pi) + "</span><br>";
                   if(att.notes) sampleDetail += "<span class='field-heading-sm'>Notes: </span><span class='field-data-sm'>" + check(att.notes) + "</span><br>";
                   sampleDetail += "</div>";
                   fields3 += sampleDetail;
                 });
                 
                 $('#samplingDataExpand').empty().append(fields3 || "<i>No detailed sample data.</i>");
             } else { $('#samplingData, #samplingDataExpand').empty().html("<i>Error or no sample data found.</i>"); console.error("Sampling Data Fetch Error:", results[2].reason); }

         }).finally(() => {
             hideLoading(); // Hide loading indicator when all fetches are done
         });
    }

    // Helper function to check for null/undefined/empty values
    function check(val) {
        // Explicitly check for null or undefined
        if (val === null || typeof val === 'undefined') {
             return "--"; // Return double dash for missing data
        }
        // Convert to string and trim whitespace
        const strVal = String(val).trim();
        // Return double dash if the trimmed string is empty
        return strVal === "" ? "--" : strVal;
    }

  </script>

</body>
</html>